# Руководство по запуску Language Learning Bot

## Содержание
1. [Общая информация](#общая-информация)
2. [Последовательность запуска](#последовательность-запуска)
3. [Запуск MongoDB](#запуск-mongodb)
4. [Запуск бэкенда](#запуск-бэкенда)
5. [Запуск фронтенда](#запуск-фронтенда)
6. [Режим автоматического перезапуска](#режим-автоматического-перезапуска)
7. [Управление запущенными процессами](#управление-запущенными-процессами)
8. [Мониторинг логов](#мониторинг-логов)
9. [Проверка работоспособности](#проверка-работоспособности)
10. [Устранение проблем](#устранение-проблем)

## Общая информация

Language Learning Bot состоит из трех основных компонентов, которые необходимо запускать в определенной последовательности:

1. **MongoDB** - база данных для хранения информации о языках, словах и пользователях
2. **Бэкенд (REST API)** - сервер, обрабатывающий запросы и взаимодействующий с базой данных
3. **Фронтенд (Telegram-бот)** - интерфейс взаимодействия с пользователем через Telegram

Для правильной работы всех компонентов требуется:
- Python 3.8+
- MongoDB 5.0+
- Telegram Bot API ключ (токен)

## Последовательность запуска

Для корректной работы приложения необходимо запускать компоненты в следующем порядке:

1. MongoDB (база данных)
2. Бэкенд (REST API)
3. Фронтенд (Telegram-бот)

Ниже будет подробно рассмотрен процесс запуска каждого компонента.

## Запуск MongoDB

### Использование скрипта start_1_db.sh

Рекомендуемый способ запуска MongoDB:

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x start_1_db.sh

# Запустить MongoDB
./start_1_db.sh
```

Скрипт автоматически:
- Загружает настройки из файла `.env`
- Проверяет, запущен ли уже экземпляр MongoDB
- Создает необходимые директории при их отсутствии
- Запускает MongoDB в фоновом режиме

### Ручной запуск MongoDB

Альтернативный способ запуска MongoDB:

```bash
# Запуск с конфигурационным файлом
~/mongodb/bin/mongod --config ~/mongodb/config/mongod.conf --fork

# Проверка запуска
ps aux | grep mongod
```

## Запуск бэкенда

### Использование скрипта start_2_backend.sh

Рекомендуемый способ запуска бэкенда:

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x start_2_backend.sh

# Запустить бэкенд
./start_2_backend.sh
```

Скрипт автоматически:
- Проверяет, запущен ли уже бэкенд
- Завершает конфликтующие процессы
- Запускает Python-модуль с нужными параметрами
- Сохраняет PID процесса для последующего управления

### Запуск бэкенда на альтернативном порту

Если порт по умолчанию (8500) занят, вы можете указать другой порт:

```bash
# С использованием переменной окружения
PORT=8501 ./start_2_backend.sh

# Или напрямую через параметр
./start_2_backend.sh --port=8501
```

### Ручной запуск бэкенда

Альтернативный способ запуска бэкенда:

```bash
# Активация окружения (если используется Conda)
conda activate language-learning-bot

# Запуск бэкенда с указанием порта
cd backend
python -m app.main --process-name=backend --port=8500
```

## Запуск фронтенда

### Использование скрипта start_3_frontend.sh

Рекомендуемый способ запуска фронтенда:

```bash
# Сделать скрипт исполняемым (если еще не сделано)
chmod +x start_3_frontend.sh

# Запустить фронтенд
./start_3_frontend.sh
```

Скрипт автоматически:
- Проверяет, запущен ли уже фронтенд
- Завершает конфликтующие процессы
- Запускает Python-модуль с нужными параметрами
- Сохраняет PID процесса для последующего управления

### Ручной запуск фронтенда

Альтернативный способ запуска фронтенда:

```bash
# Активация окружения (если используется Conda)
conda activate language-learning-bot

# Запуск фронтенда
cd frontend
python -m app.main_frontend --process-name=frontend
```

## Режим автоматического перезапуска

Режим автоматического перезапуска полезен при разработке для быстрого применения изменений кода.

### Установка необходимых зависимостей

```bash
# Сделать скрипт исполняемым
chmod +x setup_watchdog.sh

# Установить зависимости для автоперезапуска
./setup_watchdog.sh
```

### Запуск фронтенда с автоперезапуском

```bash
# Сделать скрипт исполняемым
chmod +x start_3_frontend_auto_reload.sh

# Запустить фронтенд в режиме автоперезапуска
./start_3_frontend_auto_reload.sh
```

Фронтенд будет автоматически перезапускаться при изменении файлов в директориях:
- `frontend/app/`
- `frontend/conf/config/`

### Настройка отслеживаемых файлов

По умолчанию отслеживаются файлы с расширениями `.py`, `.yaml`, `.yml` и `.json`. Для изменения этого поведения отредактируйте параметры в скрипте `start_3_frontend_auto_reload.sh`.

## Управление запущенными процессами

### Проверка запущенных процессов

```bash
# Показать PID бэкенда из файла
cat .backend.pid

# Показать PID фронтенда из файла
cat .frontend.pid

# Проверка процесса по PID
ps -p $(cat .backend.pid)

# Поиск процессов по идентификатору
ps aux | grep -e "--process-name=frontend"
ps aux | grep -e "--process-name=backend"
ps aux | grep mongod
```

### Завершение процессов

```bash
# Корректное завершение бэкенда
kill $(cat .backend.pid)

# Корректное завершение фронтенда
kill $(cat .frontend.pid)

# Принудительное завершение в случае зависания
kill -9 $(cat .backend.pid)
kill -9 $(cat .frontend.pid)

# Завершение по идентификатору процесса
pkill -f -- "--process-name=frontend"
pkill -f -- "--process-name=backend"
pkill -f mongod
```

## Мониторинг логов

### Просмотр логов MongoDB

```bash
# Просмотр последних записей в логе MongoDB
tail -f ~/mongodb/log/mongod.log
```

### Просмотр логов бэкенда

```bash
# Просмотр последних записей в логе бэкенда
tail -f backend/logs/backend.log
```

### Просмотр логов фронтенда

```bash
# Просмотр последних записей в логе фронтенда
tail -f frontend/logs/app.log
```

### Просмотр всех логов одновременно

```bash
# Использование multitail (требуется установка)
multitail ~/mongodb/log/mongod.log backend/logs/backend.log frontend/logs/app.log
```

## Проверка работоспособности

### Проверка бэкенда

```bash
# Проверка доступности API
curl http://localhost:8500/api/health

# Проверка списка языков
curl http://localhost:8500/api/languages
```

### Проверка фронтенда

1. Откройте Telegram
2. Найдите вашего бота по имени или ссылке
3. Отправьте команду `/start`
4. Проверьте отправку и получение сообщений

### Мониторинг ресурсов

```bash
# Просмотр использования CPU и памяти
ps -o pid,cmd,%cpu,%mem -p $(pgrep -f mongod) $(pgrep -f -- "--process-name=backend") $(pgrep -f -- "--process-name=frontend")

# Мониторинг в реальном времени
top -p $(pgrep -f mongod),$(pgrep -f -- "--process-name=backend"),$(pgrep -f -- "--process-name=frontend")
```

## Устранение проблем

### MongoDB не запускается

**Симптомы**: Ошибки при запуске MongoDB, скрипт `start_1_db.sh` завершается с ошибкой.

**Решения**:
1. Проверьте логи MongoDB:
   ```bash
   cat ~/mongodb/log/mongod.log
   ```

2. Проверьте наличие директорий для данных и логов:
   ```bash
   ls -la ~/mongodb/data
   ls -la ~/mongodb/log
   ```

3. Проверьте права доступа к директориям:
   ```bash
   chmod 755 ~/mongodb/data
   chmod 755 ~/mongodb/log
   ```

4. Проверьте, не занят ли порт MongoDB:
   ```bash
   lsof -i :27017
   ```

5. Если порт занят, завершите процесс:
   ```bash
   pkill -f mongod
   ```

### Бэкенд не запускается

**Симптомы**: Ошибки при запуске бэкенда, скрипт `start_2_backend.sh` завершается с ошибкой.

**Решения**:
1. Проверьте логи бэкенда:
   ```bash
   cat backend/logs/backend.log
   ```

2. Проверьте, не занят ли порт бэкенда:
   ```bash
   lsof -i :8500
   ```

3. Проверьте подключение к MongoDB:
   ```bash
   mongo --eval "db.stats()"
   ```

4. Проверьте переменные окружения:
   ```bash
   source


### Проблемы с обработкой команд в aiogram 3.x

**Симптомы**: Команды (например, `/cancel`) не обрабатываются в определенных состояниях FSM.

**Решения**:
1. Проверьте порядок включения роутеров:
   ```python
   # Правильный порядок роутеров: специфические команды перед общими обработчиками
   hint_router.include_router(cancel_router)  # Сначала проверяем команду /cancel
   hint_router.include_router(create_router)
   hint_router.include_router(edit_router)

Используйте приоритеты для важных команд:
python@router.message(Command("cancel"), SomeState, flags={"priority": 100})

Проверьте регистрацию команд в Telegram:
pythonBOT_COMMANDS = [
    # Другие команды...
    {"command": "cancel", "description": "Отменить текущее действие"}
]