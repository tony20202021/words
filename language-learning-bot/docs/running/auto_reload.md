# Автоматический перезапуск фронтенда

## Содержание
1. [Введение](#введение)
2. [Установка необходимых зависимостей](#установка-необходимых-зависимостей)
3. [Запуск с автоперезапуском](#запуск-с-автоперезапуском)
4. [Параметры и настройка](#параметры-и-настройка)
5. [Как это работает](#как-это-работает)
6. [Устранение проблем](#устранение-проблем)
7. [Производительность и ограничения](#производительность-и-ограничения)

## Введение

Функция автоматического перезапуска позволяет мгновенно видеть результаты изменений в коде и конфигурации без необходимости ручного перезапуска бота. Это существенно ускоряет процесс разработки и тестирования.

Основные преимущества:
- Мгновенное применение изменений в коде
- Автоматический перезапуск при изменении конфигурации
- Выделенное логирование процесса разработки
- Возможность гибкой настройки отслеживаемых файлов

## Установка необходимых зависимостей

Для работы автоматического перезапуска требуется библиотека `watchdog`, которая отслеживает изменения в файловой системе. Самый простой способ установить все необходимые зависимости:

```bash
# Сделать скрипт исполняемым
chmod +x setup_watchdog.sh

# Запустить скрипт установки
./setup_watchdog.sh
```

Скрипт проверит наличие библиотеки `watchdog` и установит её при необходимости.

## Запуск с автоперезапуском

Для запуска фронтенда в режиме автоматического перезапуска:

```bash
# Сделать скрипт исполняемым
chmod +x start_3_frontend_auto_reload.sh

# Запустить фронтенд в режиме автоперезапуска
./start_3_frontend_auto_reload.sh
```

После запуска система будет отслеживать изменения в указанных директориях и файлах. При обнаружении изменений фронтенд будет автоматически перезапущен.

## Параметры и настройка

Стандартная конфигурация настроена на отслеживание:
- Директорий: `frontend/app` и `frontend/conf/config`
- Файлов с расширениями: `.py`, `.yaml`, `.yml`, `.json`
- Игнорируются директории: `__pycache__`, `.git`, `env`, `venv`, `.env`, `.venv`, `logs`

### Изменение параметров мониторинга

Параметры мониторинга указаны в скрипте `start_3_frontend_auto_reload.sh`:

```bash
python frontend/watch_and_reload.py \
    --script frontend/app/main_frontend.py \
    --paths frontend/app frontend/conf/config \
    --process-name frontend_autoreload \
    --extensions .py .yaml .yml .json \
    --ignore-dirs __pycache__ .git env venv .env .venv logs
```

Вы можете отредактировать скрипт и изменить параметры:

- `--script` - путь к основному скрипту фронтенда
- `--paths` - директории для мониторинга (через пробел для нескольких)
- `--extensions` - расширения файлов для отслеживания
- `--ignore-dirs` - директории для игнорирования
- `--process-name` - имя процесса для идентификации

### Ручная настройка с дополнительными параметрами

Для более точной настройки вы можете запустить скрипт `watch_and_reload.py` напрямую:

```bash
python frontend/watch_and_reload.py \
    --script frontend/app/main_frontend.py \
    --paths frontend/app/bot/handlers frontend/app/utils \
    --extensions .py \
    --ignore-dirs __pycache__ \
    --process-name custom_name \
    --throttle-interval 3
```

## Как это работает

Механизм автоматического перезапуска состоит из нескольких компонентов:

### 1. Наблюдатель за файловой системой

Скрипт `watch_and_reload.py` использует библиотеку `watchdog` для мониторинга изменений в файловой системе. При обнаружении изменений в отслеживаемых файлах запускается процесс перезапуска.

### 2. Обработчик изменений

```python
class ChangeHandler(FileSystemEventHandler):
    """Обработчик событий файловой системы."""
    
    def should_process_event(self, event) -> bool:
        # Фильтрация событий по расширению и директории
        
    def on_modified(self, event):
        # Обработка события изменения файла
        
    def on_created(self, event):
        # Обработка события создания файла
```

Обработчик фильтрует события и применяет механизм троттлинга для предотвращения частых перезапусков.

### 3. Управление процессом

```python
class BotProcess:
    """Класс для управления процессом бота."""
    
    def start(self) -> None:
        # Запуск процесса бота
        
    def stop(self) -> None:
        # Остановка процесса бота
        
    def restart(self) -> None:
        # Перезапуск процесса бота
```

Этот класс обеспечивает корректное управление процессом бота (остановка и запуск).

### 4. Потоки выполнения

Скрипт использует несколько потоков:
- Основной поток управляет мониторингом и реагирует на сигналы завершения
- Поток наблюдателя (Observer) мониторит файловую систему
- Отдельный поток выполняет сам бот Telegram

## Устранение проблем

### Скрипт не перезапускает бот при изменении файлов

Возможные причины и решения:

1. **Библиотека watchdog не установлена**
   - Запустите `setup_watchdog.sh` для установки библиотеки

2. **Изменения происходят в файлах, которые не отслеживаются**
   - Проверьте параметры `--paths` и `--extensions`
   - Убедитесь, что изменяемые файлы не находятся в игнорируемых директориях

3. **Процесс бота не может быть остановлен**
   - Проверьте наличие нескольких экземпляров процесса: `ps aux | grep main_frontend.py`
   - Вручную завершите все процессы: `pkill -f main_frontend.py`

### Бот перезапускается слишком часто

Причина: Возможно, одновременно изменяется несколько файлов, или IDE создает временные файлы.

Решение: Увеличьте интервал троттлинга, добавив параметр `--throttle-interval`:

```bash
python frontend/watch_and_reload.py \
    ... другие параметры ... \
    --throttle-interval 5
```

### Проблемы с состоянием пользователей при перезапуске

При перезапуске бота могут возникать проблемы с сохранением состояния диалога для пользователей. Для минимизации этих проблем:

1. Убедитесь, что все состояния корректно сохраняются в базе данных
2. Реализуйте механизм восстановления сессии при перезапуске
3. Во время активной разработки используйте тестовых пользователей

### Конфликты процессов

Если возникают конфликты между несколькими запущенными экземплярами бота:

```bash
# Поиск всех процессов и их PID
ps aux | grep -e "main_frontend.py" -e "frontend_autoreload"

# Завершение всех процессов фронтенда
pkill -f -- "--process-name=frontend"
pkill -f -- "--process-name=frontend_autoreload"
```

## Производительность и ограничения

### Воздействие на системные ресурсы

Режим автоперезапуска потребляет дополнительные ресурсы системы:

- Постоянный мониторинг файловой системы требует некоторого CPU
- Частые перезапуски увеличивают нагрузку на систему
- Дополнительная нагрузка на Telegram API при частых переподключениях

### Рекомендации по использованию

1. **Используйте режим автоперезапуска только для разработки и тестирования**
   - Не рекомендуется использовать в production-среде

2. **Ограничьте область мониторинга**
   - Указывайте только те директории, которые активно изменяются
   - Используйте конкретные расширения файлов

3. **Настройте оптимальный интервал троттлинга**
   - Слишком короткий интервал приведет к частым перезапускам
   - Слишком длинный интервал замедлит цикл разработки

4. **Ограничьте количество одновременных разработчиков**
   - При работе нескольких разработчиков с одним экземпляром бота возможны конфликты

5. **Регулярно проверяйте наличие "зомби" процессов**
   - Используйте `ps aux | grep python` для обнаружения оставшихся процессов