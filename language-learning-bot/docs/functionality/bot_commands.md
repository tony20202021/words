# Команды и действия бота

## Содержание
1. [Основные команды пользователя](#основные-команды-пользователя)
2. [Административные команды](#административные-команды)
3. [Действия пользователя](#действия-пользователя)
4. [Действия администратора](#действия-администратора)
5. [Состояния и FSM](#состояния-и-fsm)
6. [Структура обработчиков](#структура-обработчиков)
7. [Клавиатуры](#клавиатуры)
8. [Примеры использования](#примеры-использования)

## Основные команды пользователя

| Команда       | Описание                                      | Обработчик                        | Файл                               |
|--------------|--------------------------------------------|----------------------------------|------------------------------------|
| `/start`      | Начать работу с ботом, отображение приветствия | `cmd_start`                      | user/basic_handlers.py             |
| `/help`       | Получить справку по работе с ботом            | `cmd_help`                       | user/help_handlers.py              |
| `/language`   | Выбрать язык для изучения                     | `cmd_language`                   | language_handlers.py               |
| `/settings`   | Настройки процесса обучения                   | `cmd_settings`                   | user/settings_handlers.py          |
| `/study`      | Начать изучение слов                         | `cmd_study`                      | study/study_commands.py            |
| `/stats`      | Показать статистику изучения                  | `cmd_stats`                      | user/stats_handlers.py             |
| `/hint`       | Информация о подсказках                       | `cmd_hint`                       | user/hint_handlers.py              |
| `/cancel`     | Отмена текущего действия                     | Встроен в обработчики состояний     | Различные handlers                 |

## Административные команды

| Команда       | Описание                                      | Обработчик                        | Файл                               |
|--------------|--------------------------------------------|----------------------------------|------------------------------------|
| `/admin`      | Вход в административную панель                | `cmd_admin`                      | admin/admin_basic_handlers.py      |
| `/managelang` | Управление языками                           | `cmd_manage_languages`           | admin/admin_language_handlers.py   |
| `/upload`     | Загрузка файла со словами                     | `cmd_upload`                     | admin/admin_upload_handlers.py     |
| `/admin_stats`| Административная статистика                   | `cmd_admin_stats`                | admin/admin_basic_handlers.py      |

## Действия пользователя

### Выбор языка
| Действие                | Описание                             | Обработчик                        | Файл                               |
|------------------------|-------------------------------------|----------------------------------|------------------------------------|
| `lang_select_*`        | Выбор языка для изучения             | `process_language_selection`     | language_handlers.py               |

### Настройки обучения
| Действие                      | Описание                             | Обработчик                           | Файл                               |
|------------------------------|-------------------------------------|-------------------------------------|------------------------------------|
| `settings_start_word`        | Изменение стартового слова           | `process_settings_start_word`       | user/settings_handlers.py          |
| `settings_toggle_skip_marked`| Переключение пропуска помеченных слов | `process_settings_toggle_skip_marked`| user/settings_handlers.py          |
| `settings_toggle_check_date` | Переключение учета даты проверки      | `process_settings_toggle_check_date` | user/settings_handlers.py          |
| `settings_toggle_show_hints` | Переключение отображения подсказок    | `process_settings_toggle_show_hints` | user/settings_handlers.py          |

### Процесс изучения слов
| Действие                | Описание                             | Обработчик                        | Файл                               |
|------------------------|-------------------------------------|----------------------------------|------------------------------------|
| `word_know`            | Отметить слово как известное          | `process_word_know`              | study/study_word_actions.py        |
| `word_dont_know`       | Отметить слово как неизвестное        | `process_word_dont_know`         | study/study_word_actions.py        |
| `show_word`            | Показать слово на изучаемом языке     | `process_show_word`              | study/study_word_actions.py        |
| `next_word`            | Перейти к следующему слову после показа | `process_next_word`             | study/study_word_actions.py        |
| `confirm_next_word`    | Подтвердить переход к следующему слову | `process_confirm_next_word`      | study/study_word_actions.py        |
| `toggle_word_skip`     | Переключить флаг пропуска слова       | `process_toggle_word_skip`       | study/study_word_actions.py        |

### Работа с подсказками
| Действие                | Описание                             | Обработчик                        | Файл                               |
|------------------------|-------------------------------------|----------------------------------|------------------------------------|
| `hint_view_*`          | Показать подсказку для слова          | `process_hint_view`              | study/hint/view_handlers.py        |
| `hint_create_*`        | Добавить новую подсказку             | `process_hint_create`            | study/hint/create_handlers.py      |
| `hint_edit_*`          | Редактировать существующую подсказку  | `process_hint_edit`              | study/hint/edit_handlers.py        |
| `hint_toggle_*`        | Переключить видимость подсказки       | `process_hint_toggle`            | study/hint/toggle_handlers.py      |
| `back_to_word`         | Вернуться к слову после подсказки     | `process_back_to_word`           | study/hint/view_handlers.py        |
| `cancel_action`        | Отменить текущее действие            | `process_cancel_action`          | study/hint/common.py               |

## Действия администратора

### Управление языками
| Действие                    | Описание                             | Обработчик                            | Файл                                  |
|----------------------------|-------------------------------------|--------------------------------------|---------------------------------------|
| `admin_languages`          | Просмотр списка языков                | `process_admin_languages`            | admin/admin_language_handlers.py      |
| `create_language`          | Создание нового языка                 | `process_create_language`            | admin/admin_language_handlers.py      |
| `view_languages`           | Просмотр списка языков                | `process_view_languages`             | admin/admin_language_handlers.py      |
| `edit_language_*`          | Редактирование языка                  | `process_edit_language`              | admin/admin_language_handlers.py      |
| `edit_name_ru_*`           | Изменение русского названия языка      | `process_edit_name_ru`               | admin/admin_language_handlers.py      |
| `edit_name_foreign_*`      | Изменение оригинального названия языка | `process_edit_name_foreign`          | admin/admin_language_handlers.py      |
| `delete_language_*`        | Удаление языка                        | `process_delete_language`            | admin/admin_language_handlers.py      |
| `confirm_delete_*`         | Подтверждение удаления языка           | `process_confirm_delete_language`    | admin/admin_language_handlers.py      |
| `cancel_delete_*`          | Отмена удаления языка                 | `process_cancel_delete_language`     | admin/admin_language_handlers.py      |
| `search_word_by_number_*`  | Поиск слова по номеру                 | `process_search_word_by_number`      | admin/admin_language_handlers.py      |
| `upload_to_lang_*`         | Загрузка файла для языка              | `process_language_selection_for_upload` | admin/admin_upload_handlers.py     |

### Административная статистика
| Действие                | Описание                             | Обработчик                        | Файл                               |
|------------------------|-------------------------------------|----------------------------------|------------------------------------|
| `admin_stats`          | Просмотр административной статистики   | `process_admin_stats`           | admin/admin_basic_handlers.py      |

### Управление файлами
| Действие                | Описание                             | Обработчик                        | Файл                               |
|------------------------|-------------------------------------|----------------------------------|------------------------------------|
| `column_*`             | Выбор колонки для загрузки файла      | `process_column_configuration`    | admin/admin_upload_handlers.py     |
| `confirm_upload`       | Подтверждение загрузки файла          | `process_column_configuration`    | admin/admin_upload_handlers.py     |

## Состояния и FSM

Бот использует конечный автомат состояний (FSM) для управления диалогами с пользователем.

### Состояния пользователя
- `SettingsStates.waiting_start_word` - ожидание ввода начального слова (можно отменить командой `/cancel`)
- `StudyStates.studying` - изучение слов (объединенный режим изучения и повторения)
- `HintStates.creating` - создание подсказки
- `HintStates.editing` - редактирование подсказки

### Состояния администратора
- `AdminStates.waiting_file` - ожидание загрузки файла
- `AdminStates.configuring_columns` - настройка колонок файла
- `AdminStates.creating_language_name` - создание языка (ввод русского названия)
- `AdminStates.creating_language_native_name` - создание языка (ввод оригинального названия)
- `AdminStates.editing_language_name` - редактирование русского названия языка
- `AdminStates.editing_language_native_name` - редактирование оригинального названия языка
- `AdminStates.input_word_number` - ввод номера слова для поиска

## Структура обработчиков

Обработчики команд и действий организованы в модульную структуру:

### Фронтенд (app/bot/handlers)
```
app/bot/handlers/
├── admin_handlers.py                   # Главный модуль администратора
├── user_handlers.py                    # Главный модуль пользователя
├── language_handlers.py                # Выбор языка
├── study_handlers.py                   # Главный модуль изучения слов
├── admin/                              # Подмодули администратора
│   ├── admin_basic_handlers.py         # Базовые команды (/admin, /admin_stats)
│   ├── admin_language_handlers.py      # Управление языками (/managelang)
│   ├── admin_upload_handlers.py        # Загрузка файлов (/upload)
│   └── admin_states.py                 # Состояния FSM администратора
├── user/                               # Подмодули пользователя
│   ├── basic_handlers.py               # Базовые команды (/start)
│   ├── help_handlers.py                # Команда /help
│   ├── hint_handlers.py                # Команда /hint
│   ├── settings_handlers.py            # Команда /settings
│   └── stats_handlers.py               # Команда /stats
└── study/                              # Подмодули изучения слов
    ├── study_commands.py               # Команда /study
    ├── study_words.py                  # Получение и отображение слов
    ├── study_word_actions.py           # Действия со словами
    ├── study_hint_handlers.py          # Главный модуль подсказок
    ├── study_states.py                 # Состояния FSM для изучения
    └── hint/                           # Подмодули для подсказок
        ├── common.py                   # Общие функции и отмена
        ├── create_handlers.py          # Создание подсказок
        ├── edit_handlers.py            # Редактирование подсказок
        ├── view_handlers.py            # Просмотр подсказок
        └── toggle_handlers.py          # Переключение видимости
```

## Клавиатуры

Бот использует специализированные клавиатуры для различных сценариев.

### Клавиатуры для пользователя (user_keyboards.py)

| Функция                         | Описание                                       |
|--------------------------------|------------------------------------------------|
| `get_skip_marked_button_text`  | Текст кнопки пропуска помеченных слов           |
| `get_check_date_button_text`   | Текст кнопки учета даты проверки               |
| `get_start_word_button_text`   | Текст кнопки изменения начального слова         |
| `get_show_hints_button_text`   | Текст кнопки отображения подсказок             |
| `create_settings_keyboard`     | Клавиатура для меню настроек                   |

### Клавиатуры для изучения слов (study_keyboards.py)

| Функция                         | Описание                                       |
|--------------------------------|------------------------------------------------|
| `create_word_keyboard`         | Клавиатура для взаимодействия со словом с учетом настройки show_hints |
| `create_hint_actions_keyboard` | Клавиатура для действий с подсказками           |
| `create_cancel_action_keyboard`| Клавиатура с кнопкой отмены                    |

### Клавиатуры для администратора (admin_keyboards.py)

| Функция                           | Описание                                        |
|----------------------------------|------------------------------------------------|
| `get_admin_keyboard`              | Клавиатура для меню администратора              |
| `get_languages_keyboard`          | Клавиатура для списка языков                    |
| `get_edit_language_keyboard`      | Клавиатура для редактирования языка             |
| `get_back_to_languages_keyboard`  | Клавиатура с кнопкой возврата к языкам          |
| `get_word_actions_keyboard`       | Клавиатура с действиями для слова               |
| `get_yes_no_keyboard`             | Клавиатура с кнопками "Да" и "Нет"              |
| `get_upload_columns_keyboard`     | Клавиатура для настройки колонок файла          |
| `get_back_to_admin_keyboard`      | Клавиатура с кнопкой возврата к админке         |

## Примеры использования

### Пример 1: Начало работы и выбор языка

1. Пользователь отправляет команду `/start`
2. Бот отображает приветственное сообщение
3. Пользователь отправляет команду `/language`
4. Бот отображает список доступных языков
5. Пользователь выбирает язык, нажав на соответствующую кнопку (`lang_select_*`)
6. Бот подтверждает выбор языка и предлагает начать изучение

### Пример 2: Настройка процесса обучения

1. Пользователь отправляет команду `/settings`
2. Бот отображает текущие настройки и кнопки для их изменения
3. Пользователь нажимает кнопку `settings_toggle_skip_marked`
4. Бот обновляет настройку и отображает обновленное состояние
5. Пользователь нажимает кнопку `settings_start_word`
6. Бот запрашивает новое начальное слово
7. Пользователь вводит номер слова (например, "5")
8. Бот обновляет настройку и отображает обновленное состояние

### Пример 3: Изучение слов

1. Пользователь отправляет команду `/study`
2. Бот отображает первое слово для изучения (на русском языке)
3. Пользователь может:
   - Нажать "Я знаю это слово" (`word_know`)
   - Нажать "Показать слово" (`show_word`)
   - Нажать "Не знаю слово" (`word_dont_know`)
   - Нажать кнопку одной из подсказок
4. Если пользователь нажимает "Я знаю это слово", бот показывает слово на иностранном языке и кнопку "Перейти к следующему слову"
5. Если пользователь нажимает "Не знаю слово", бот показывает слово на иностранном языке и кнопку "Перейти к следующему слову" 
6. Если пользователь нажимает "Показать слово", бот показывает слово на иностранном языке и кнопку "Следующее слово"
7. После нажатия на кнопку "Перейти к следующему слову" или "Следующее слово", бот переходит к следующему слову
8. Если пользователь нажимает на кнопку подсказки, бот показывает или создает подсказку и устанавливает оценку 0

### Пример 4: Административные функции

1. Администратор отправляет команду `/admin`
2. Бот отображает административное меню
3. Администратор выбирает "Управление языками" (`admin_languages`)
4. Бот отображает список языков и доступные действия
5. Администратор может:
   - Создать новый язык (`create_language`)
   - Редактировать существующий язык (`edit_language_*`)
   - Удалить язык (`delete_language_*`)
   - Искать слово по номеру (`search_word_by_number_*`)

## Дополнительная информация

### Обработка команды `/cancel`

Обработка команды `/cancel` встроена непосредственно в каждый обработчик состояния для корректной работы. Например, в состоянии `waiting_start_word` команда `/cancel` отменяет ввод начального слова и возвращает пользователя к экрану настроек.

### Функции форматирования текста (formatting_utils.py)

| Функция                     | Описание                                     |
|----------------------------|----------------------------------------------|
| `format_date`              | Форматирует дату в читаемую форму             |
| `format_date_standard`     | Форматирует дату в стандартный формат дд.мм.гггг |
| `format_settings_text`     | Форматирует текст настроек с опциональными префиксом и суффиксом |
| `format_active_hints`      | Форматирует список активных подсказок для отображения |
| `format_study_word_message`| Форматирует сообщение с информацией о слове    |

### Улучшения в процессе изучения слов

В системе изучения слов реализованы следующие улучшения:

1. Добавлена подтверждаемая навигация между словами - после оценки слова пользователь должен явно подтвердить переход к следующему слову, нажав соответствующую кнопку
2. Созданные подсказки автоматически отображаются на экране изучения слова
3. Кнопки уже просмотренных подсказок больше не отображаются в клавиатуре
4. Кнопки с разнообразными надписями сгруппированы по функциональности для более интуитивного интерфейса
5. Сохранен механизм автоматической установки оценки 0 при использовании подсказки
6. Улучшено отображение состояния слова и подсказок для более понятного интерфейса