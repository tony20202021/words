Архитектура проекта (обновлено)
Содержание

Общий обзор
Схема взаимодействия компонентов
Структура базы данных MongoDB
Frontend (Telegram-бот)

Компоненты Frontend
Процесс взаимодействия с пользователем
Архитектурные улучшения


Backend (REST API)

Архитектурные слои Backend
Технический стек Backend


Подсистема изучения слов
Система настроек пользователя
Меры безопасности и производительности
Схема потока данных
Модернизация архитектуры

Общий обзор
Language Learning Bot построен на модульной архитектуре с чётким разделением на четыре основные части:

Frontend (Telegram-бот) - отвечает за взаимодействие с пользователем через Telegram API
Backend (REST API) - обрабатывает запросы от фронтенда и работает с базой данных MongoDB
Common (Общие модули) - содержит утилиты и модули, используемые как фронтендом, так и бэкендом
Централизованные утилиты - новый слой для управления константами, состояниями и общей логикой

Такое разделение обеспечивает гибкость и масштабируемость: в будущем можно легко заменить фронтенд на другой интерфейс (мобильное приложение, веб-интерфейс), сохранив функциональность бэкенда, при этом продолжая использовать общие утилиты для обеспечения единообразного поведения всей системы.
Схема взаимодействия компонентов (ОБНОВЛЕНО)
┌─────────────────┐      HTTP      ┌─────────────────┐      MongoDB     ┌─────────────────┐
│                 │     запросы    │                 │     драйвер      │                 │
│   Frontend      │◄──────────────►│    Backend      │◄────────────────►│    MongoDB      │
│   (Telegram)    │                │    (REST API)   │                  │   (Database)    │
│                 │                │                 │                  │                 │
└─────────┬───────┘                └─────────────────┘                  └─────────────────┘
          │                                                                     ▲
          │                                                                     │
          ▼                                                                     │
┌─────────────────┐                                                   ┌─────────┴─────────┐
│  Централизованные │                                                   │                   │
│     Утилиты      │                                                   │   Администратор   │
│                 │                                                   │   (Консоль)       │
│ • Константы     │                                                   │                   │
│ • Состояния FSM │                                                   └───────────────────┘
│ • Голосовые     │
│ • Middleware    │
└─────────────────┘
          ▲
          │ Telegram Bot API
          │
┌─────────┴───────┐
│               │
│  Пользователь │
│    (Чат)      │
│               │
└───────────────┘
Структура базы данных MongoDB
MongoDB - документоориентированная NoSQL база данных, в проекте используются следующие коллекции:
КоллекцияОписаниеКлючевые поляlanguagesИнформация о языках для изучения_id, name_ru, name_foreignwordsСлова для изучения_id, language_id, word_foreign, translation, transcription, word_numberusersПользователи системы_id, telegram_id, username, first_name, last_name, is_adminuser_statisticsСтатистика изучения слов_id, user_id, word_id, language_id, score, check_interval, next_check_dateuser_language_settingsНастройки пользователей по языкам_id, user_id, language_id, start_word, skip_marked, use_check_date, show_hints, show_debug
Frontend (Telegram-бот)
Frontend построен на улучшенной модульной архитектуре:
Компоненты Frontend

API Client - модуль взаимодействия с Backend API
Централизованные утилиты - новый слой архитектуры:

Callback Constants - централизованное управление callback_data
Voice Utils - обработка голосовых сообщений
Centralized States - все состояния FSM в одном месте
Enhanced Middleware - улучшенная аутентификация и авторизация


Bot Handlers - обработчики команд, разделенные на логические группы:

admin/ - обработчики администрирования (с использованием констант)
user/ - обработчики пользовательских команд (с голосовой поддержкой)
study/ - обработчики для изучения слов (полностью рефакторированы)


Keyboards - модули формирования клавиатур (все обновлены)
Utils - утилиты для обработки ошибок, форматирования, работы с API
States - централизованные определения состояний FSM

Процесс взаимодействия с пользователем (УЛУЧШЕННЫЙ)
┌───────────────┐         ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│               │         │               │         │               │         │               │
│  Сообщение    │─────────►  AuthMiddleware│─────────►  Обработчик   │─────────►    Backend    │
│  пользователя │         │               │         │    команд     │         │               │
│               │         │ • Регистрация │         │ • Константы   │         │               │  
└───────────────┘         │ • Авторизация │         │ • Парсеры     │         └───────────────┘
                          │ • Инжекция    │         │ • Голос       │                 │
                          └───────────────┘         └───────────────┘                 │
                                  │                         │                         ▼
                                  │                         ▼                 ┌───────────────┐
                                  ▼                 ┌───────────────┐         │               │
                          ┌───────────────┐         │  Формирование │         │   Обработка   │
                          │  Централиз.   │         │   ответа и    │◄────────┤   запроса и   │
                          │   Утилиты     │         │  клавиатуры   │         │  базы данных  │
                          │               │         │ • Константы   │         │               │
                          │ • Voice Utils │         │ • Генераторы  │         └───────────────┘
                          │ • Constants   │         └───────────────┘
                          │ • States      │                 │
                          └───────────────┘                 │
                                                           ▼
                                                   ┌───────────────┐
                                                   │               │
                                                   │    Ответ      │
                                                   │ пользователю  │
                                                   │               │
                                                   └───────────────┘
                                                   
## Backend (REST API)

Backend предоставляет REST API для взаимодействия с базой данных.

### Архитектурные слои Backend

1. **Маршруты (Routes)** - обрабатывают HTTP запросы и ответы
2. **Сервисы (Services)** - содержат бизнес-логику
3. **Репозитории (Repositories)** - отвечают за доступ к данным

```
┌───────────────────────────────────────────────────┐
│                      Routes                        │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │languages│   │  words  │   │  users  │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                     Services                       │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │ service │   │ service │   │ service │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                   Repositories                     │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │repository│  │repository│  │repository│         │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                    MongoDB                         │
└───────────────────────────────────────────────────┘
```

### Технический стек Backend

- **FastAPI** - асинхронный фреймворк для API
- **Motor** - асинхронный драйвер MongoDB для Python
- **Pydantic** - валидация данных и сериализация
- **Hydra** - управление конфигурацией

## Подсистема изучения слов

Подсистема изучения слов включает несколько компонентов:

### 1. Модели данных
- **UserWordState** - состояние изучения слова
- **HintState** - состояние подсказок

### 2. Процесс изучения слов
```
┌────────────────┐
│  Начало        │
│  процесса      │
│  (/study)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  Получение     │
│  слов с учетом │
│  настроек      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  Отображение   │
│  слова         │
│  пользователю  │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Действия      │────────►│  Обновление    │
│  пользователя  │         │  статистики и  │
└───────┬────────┘         │  интервалов    │
        │                  └───────┬────────┘
        ▼                          │
┌────────────────┐                 │
│  Переход к     │◄────────────────┘
│  следующему    │
│  слову         │
└────────────────┘
```

### 3. Система интервального повторения

- Начальный интервал при правильном ответе: 1 день
- При последующих правильных ответах интервал увеличивается: 1→2→4→8→16→32 дня
- При неправильном ответе или использовании подсказки интервал сбрасывается в 0

## Система настроек пользователя

Система позволяет каждому пользователю настраивать процесс обучения для каждого языка:

| Настройка | Описание | Значение по умолчанию |
|-----------|----------|-------------|
| **start_word** | Начальный номер слова | 1 |
| **skip_marked** | Пропуск/показ помеченных слов | false |
| **use_check_date** | Учет даты следующей проверки | true |
| **show_hints** | Отображение кнопок подсказок | true |

Настройки хранятся в коллекции `user_language_settings` и сохраняются между сессиями.

## Меры безопасности и производительности

1. **Внедрение зависимостей (DI)** - все компоненты получают зависимости через FastAPI Depends
2. **Обработка ошибок** - централизованная система обработки ошибок API
3. **Асинхронная обработка** - неблокирующие операции для высокой производительности
4. **Валидация данных** - строгая валидация всех входящих данных через Pydantic

## Схема потока данных

Ниже представлена схема потока данных в системе:

```
┌─────────────────────┐
│                     │
│     Пользователь    │
│                     │
└──────────┬──────────┘
           │
           ▼
┌──────────────────────┐      ┌─────────────────────┐
│    Telegram-бот      │      │   База языков и     │
│    (Frontend)        │─────►│   слов (MongoDB)    │
└──────────┬───────────┘      └─────────────────────┘
           │                             ▲
           ▼                             │
┌──────────────────────┐                 │
│  Запросы к Backend   │                 │
│       API            │                 │
└──────────┬───────────┘                 │
           │                             │
           ▼                             │
┌──────────────────────┐                 │
│  Обработка запросов  │                 │
│  в Backend           │─────────────────┘
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  Данные пользователя │
│  (Прогресс, настройки)│
└──────────────────────┘
```

Эта архитектура обеспечивает:
- Независимость компонентов
- Гибкость масштабирования
- Простоту сопровождения
- Возможность быстрой разработки новых функций