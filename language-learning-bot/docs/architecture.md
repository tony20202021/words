# Архитектура проекта

## Содержание
1. [Общий обзор](#общий-обзор)
2. [Схема взаимодействия компонентов](#схема-взаимодействия-компонентов)
3. [Структура базы данных MongoDB](#структура-базы-данных-mongodb)
4. [Frontend (Telegram-бот)](#frontend-telegram-бот)
   - [Компоненты Frontend](#компоненты-frontend)
   - [Процесс взаимодействия с пользователем](#процесс-взаимодействия-с-пользователем)
5. [Backend (REST API)](#backend-rest-api)
   - [Архитектурные слои Backend](#архитектурные-слои-backend)
   - [Технический стек Backend](#технический-стек-backend)
6. [Подсистема изучения слов](#подсистема-изучения-слов)
7. [Система настроек пользователя](#система-настроек-пользователя)
8. [Меры безопасности и производительности](#меры-безопасности-и-производительности)
9. [Схема потока данных](#схема-потока-данных)

## Общий обзор

Language Learning Bot построен на модульной архитектуре с чётким разделением на три основные части:

1. **Frontend (Telegram-бот)** - отвечает за взаимодействие с пользователем через Telegram API
2. **Backend (REST API)** - обрабатывает запросы от фронтенда и работает с базой данных MongoDB
3. **Common (Общие модули)** - содержит утилиты и модули, используемые как фронтендом, так и бэкендом

Такое разделение обеспечивает гибкость и масштабируемость: в будущем можно легко заменить фронтенд на другой интерфейс (мобильное приложение, веб-интерфейс), сохранив функциональность бэкенда, при этом продолжая использовать общие утилиты для обеспечения единообразного поведения всей системы.

## Схема взаимодействия компонентов

```
┌─────────────────┐      HTTP      ┌─────────────────┐      MongoDB     ┌─────────────────┐
│                 │     запросы    │                 │     драйвер      │                 │
│   Frontend      │◄──────────────►│    Backend      │◄────────────────►│    MongoDB      │
│   (Telegram)    │                │    (REST API)   │                  │   (Database)    │
│                 │                │                 │                  │                 │
└─────────────────┘                └─────────────────┘                  └─────────────────┘
        ▲                                                                       ▲
        │                                                                       │
        │ Telegram Bot API                                                      │
        │                                                                       │
┌───────┴───────┐                                                     ┌─────────┴─────────┐
│               │                                                     │                   │
│  Пользователь │                                                     │   Администратор   │
│    (Чат)      │                                                     │   (Консоль)       │
│               │                                                     │                   │
└───────────────┘                                                     └───────────────────┘
```

## Структура базы данных MongoDB

MongoDB - документоориентированная NoSQL база данных, в проекте используются следующие коллекции:

| Коллекция | Описание | Ключевые поля |
|-----------|----------|---------------|
| **languages** | Информация о языках для изучения | _id, name_ru, name_foreign |
| **words** | Слова для изучения | _id, language_id, word_foreign, translation, transcription, word_number |
| **users** | Пользователи системы | _id, telegram_id, username, first_name, last_name, is_admin |
| **user_statistics** | Статистика изучения слов | _id, user_id, word_id, language_id, score, check_interval, next_check_date |
| **user_language_settings** | Настройки пользователей по языкам | _id, user_id, language_id, start_word, skip_marked, use_check_date, show_hints |

## Frontend (Telegram-бот)

Frontend построен на модульной архитектуре:

### Компоненты Frontend

- **API Client** - модуль взаимодействия с Backend API
- **Bot Handlers** - обработчики команд, разделенные на логические группы:
  - **admin/** - обработчики администрирования
  - **user/** - обработчики пользовательских команд
  - **study/** - обработчики для изучения слов
- **Keyboards** - модули формирования клавиатур
- **Utils** - утилиты для обработки ошибок, форматирования, работы с API
- **States** - определение состояний FSM для управления диалогами

### Процесс взаимодействия с пользователем

```
┌───────────────┐         ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│               │         │               │         │               │         │               │
│  Сообщение    │─────────►  Обработчик   │─────────►  API клиент   │─────────►    Backend    │
│  пользователя │         │    команд     │         │               │         │               │
│               │         │               │         │               │         │               │
└───────────────┘         └───────────────┘         └───────────────┘         └───────────────┘
                                  │                                                   │
                                  │                                                   │
                                  ▼                                                   ▼
                          ┌───────────────┐                                  ┌───────────────┐
                          │               │                                  │               │
                          │  Формирование │                                  │   Обработка   │
                          │   ответа и    │◄─────────────────────────────────┤   запроса и   │
                          │  клавиатуры   │                                  │  базы данных  │
                          │               │                                  │               │
                          └───────────────┘                                  └───────────────┘
                                  │
                                  │
                                  ▼
                          ┌───────────────┐
                          │               │
                          │    Ответ      │
                          │ пользователю  │
                          │               │
                          └───────────────┘
```

## Backend (REST API)

Backend предоставляет REST API для взаимодействия с базой данных.

### Архитектурные слои Backend

1. **Маршруты (Routes)** - обрабатывают HTTP запросы и ответы
2. **Сервисы (Services)** - содержат бизнес-логику
3. **Репозитории (Repositories)** - отвечают за доступ к данным

```
┌───────────────────────────────────────────────────┐
│                      Routes                        │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │languages│   │  words  │   │  users  │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                     Services                       │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │ service │   │ service │   │ service │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                   Repositories                     │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │repository│  │repository│  │repository│         │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                    MongoDB                         │
└───────────────────────────────────────────────────┘
```

### Технический стек Backend

- **FastAPI** - асинхронный фреймворк для API
- **Motor** - асинхронный драйвер MongoDB для Python
- **Pydantic** - валидация данных и сериализация
- **Hydra** - управление конфигурацией

## Подсистема изучения слов

Подсистема изучения слов включает несколько компонентов:

### 1. Модели данных
- **UserWordState** - состояние изучения слова
- **HintState** - состояние подсказок

### 2. Процесс изучения слов
```
┌────────────────┐
│  Начало        │
│  процесса      │
│  (/study)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  Получение     │
│  слов с учетом │
│  настроек      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  Отображение   │
│  слова         │
│  пользователю  │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Действия      │────────►│  Обновление    │
│  пользователя  │         │  статистики и  │
└───────┬────────┘         │  интервалов    │
        │                  └───────┬────────┘
        ▼                          │
┌────────────────┐                 │
│  Переход к     │◄────────────────┘
│  следующему    │
│  слову         │
└────────────────┘
```

### 3. Система интервального повторения

- Начальный интервал при правильном ответе: 1 день
- При последующих правильных ответах интервал увеличивается: 1→2→4→8→16→32 дня
- При неправильном ответе или использовании подсказки интервал сбрасывается в 0

## Система настроек пользователя

Система позволяет каждому пользователю настраивать процесс обучения для каждого языка:

| Настройка | Описание | Значение по умолчанию |
|-----------|----------|-------------|
| **start_word** | Начальный номер слова | 1 |
| **skip_marked** | Пропуск/показ помеченных слов | false |
| **use_check_date** | Учет даты следующей проверки | true |
| **show_hints** | Отображение кнопок подсказок | true |

Настройки хранятся в коллекции `user_language_settings` и сохраняются между сессиями.

## Меры безопасности и производительности

1. **Внедрение зависимостей (DI)** - все компоненты получают зависимости через FastAPI Depends
2. **Обработка ошибок** - централизованная система обработки ошибок API
3. **Асинхронная обработка** - неблокирующие операции для высокой производительности
4. **Валидация данных** - строгая валидация всех входящих данных через Pydantic

## Схема потока данных

Ниже представлена схема потока данных в системе:

```
┌─────────────────────┐
│                     │
│     Пользователь    │
│                     │
└──────────┬──────────┘
           │
           ▼
┌──────────────────────┐      ┌─────────────────────┐
│    Telegram-бот      │      │   База языков и     │
│    (Frontend)        │─────►│   слов (MongoDB)    │
└──────────┬───────────┘      └─────────────────────┘
           │                             ▲
           ▼                             │
┌──────────────────────┐                 │
│  Запросы к Backend   │                 │
│       API            │                 │
└──────────┬───────────┘                 │
           │                             │
           ▼                             │
┌──────────────────────┐                 │
│  Обработка запросов  │                 │
│  в Backend           │─────────────────┘
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│  Данные пользователя │
│  (Прогресс, настройки)│
└──────────────────────┘
```

Эта архитектура обеспечивает:
- Независимость компонентов
- Гибкость масштабирования
- Простоту сопровождения
- Возможность быстрой разработки новых функций