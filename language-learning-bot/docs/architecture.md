# Архитектура проекта (обновлено с Meta-состояниями)

## Содержание

1. [Общий обзор](#общий-обзор)
2. [Схема взаимодействия компонентов](#схема-взаимодействия-компонентов)
3. [Структура базы данных MongoDB](#структура-базы-данных-mongodb)
4. [Frontend (Telegram-бот)](#frontend-telegram-бот)
   - [Компоненты Frontend](#компоненты-frontend)
   - [Процесс взаимодействия с пользователем](#процесс-взаимодействия-с-пользователем)
   - [Архитектурные улучшения](#архитектурные-улучшения)
   - [НОВОЕ: Meta-состояния и системная обработка ошибок](#новое-meta-состояния-и-системная-обработка-ошибок)
5. [Backend (REST API)](#backend-rest-api)
6. [Подсистема изучения слов](#подсистема-изучения-слов)
7. [Система настроек пользователя](#система-настроек-пользователя)
8. [Меры безопасности и производительности](#меры-безопасности-и-производительности)
9. [Схема потока данных](#схема-потока-данных)
10. [Модернизация архитектуры](#модернизация-архитектуры)

## Общий обзор

Language Learning Bot построен на модульной архитектуре с чётким разделением на четыре основные части:

- **Frontend (Telegram-бот)** - отвечает за взаимодействие с пользователем через Telegram API
- **Backend (REST API)** - обрабатывает запросы от фронтенда и работает с базой данных MongoDB
- **Common (Общие модули)** - содержит утилиты и модули, используемые как фронтендом, так и бэкендом
- **Централизованные утилиты** - новый слой для управления константами, состояниями и общей логикой

**🆕 НОВОЕ:** Добавлена система meta-состояний для обработки системных ошибок, потери соединения и неизвестных команд с автоматическим восстановлением.

Такое разделение обеспечивает гибкость и масштабируемость: в будущем можно легко заменить фронтенд на другой интерфейс (мобильное приложение, веб-интерфейс), сохранив функциональность бэкенда, при этом продолжая использовать общие утилиты для обеспечения единообразного поведения всей системы.

## Схема взаимодействия компонентов (ОБНОВЛЕНО)

```
┌─────────────────┐      HTTP      ┌─────────────────┐      MongoDB     ┌─────────────────┐
│                 │     запросы    │                 │     драйвер      │                 │
│   Frontend      │◄──────────────►│    Backend      │◄────────────────►│    MongoDB      │
│   (Telegram)    │                │    (REST API)   │                  │   (Database)    │
│                 │                │                 │                  │                 │
└─────────┬───────┘                └─────────────────┘                  └─────────────────┘
          │                                  ▲                                   ▲
          │                                  │                                   │
          ▼                                  │                                   │
┌─────────────────┐                         │                          ┌─────────┴─────────┐
│ Meta-States     │                         │                          │                   │
│ Error Handling  │◄────────────────────────┘                          │   Администратор   │
│                 │                                                     │   (Консоль)       │
│ • API Errors    │                                                     │                   │
│ • Connection    │                                                     └───────────────────┘
│ • Unknown Cmds  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐                                                   ┌─────────┴─────────┐
│  Централизованные │                                                   │                   │
│     Утилиты      │                                                   │   Система         │
│                 │                                                   │   Мониторинга     │
│ • Константы     │                                                   │                   │
│ • Состояния FSM │                                                   │ • Health Check    │
│ • Голосовые     │                                                   │ • Admin Alerts    │
│ • Middleware    │                                                   │ • Auto Recovery   │
└─────────────────┘                                                   └───────────────────┘
          ▲
          │ Telegram Bot API
          │
┌─────────┴───────┐
│               │
│  Пользователь │
│    (Чат)      │
│               │
└───────────────┘
```

## Структура базы данных MongoDB

MongoDB - документоориентированная NoSQL база данных, в проекте используются следующие коллекции:

| Коллекция | Описание | Ключевые поля |
|-----------|----------|---------------|
| languages | Информация о языках для изучения | _id, name_ru, name_foreign |
| words | Слова для изучения | _id, language_id, word_foreign, translation, transcription, word_number |
| users | Пользователи системы | _id, telegram_id, username, first_name, last_name, is_admin |
| user_statistics | Статистика изучения слов | _id, user_id, word_id, language_id, score, check_interval, next_check_date |
| user_language_settings | Настройки пользователей по языкам | _id, user_id, language_id, start_word, skip_marked, use_check_date, show_hints, show_debug |

## Frontend (Telegram-бот)

Frontend построен на улучшенной модульной архитектуре с поддержкой meta-состояний:

### Компоненты Frontend

#### API Client
- Модуль взаимодействия с Backend API
- Автоматические повторные попытки при ошибках
- Унифицированные ответы с обработкой ошибок

#### 🆕 НОВОЕ: Meta-States System
- **Common Handlers** - обработчики системных состояний
- **Error Recovery** - автоматическое восстановление после ошибок
- **Health Monitoring** - мониторинг состояния системы
- **Admin Notifications** - уведомления администраторов

#### Централизованные утилиты
- **Callback Constants** - централизованное управление callback_data
- **Voice Utils** - обработка голосовых сообщений
- **Centralized States** - все состояния FSM в одном месте
- **Enhanced Middleware** - улучшенная аутентификация и авторизация

#### Bot Handlers
Обработчики команд, разделенные на логические группы:

- **🆕 common/** - обработчики meta-состояний:
  - `common_handlers.py` - системные обработчики ошибок
- **admin/** - обработчики администрирования (с использованием констант)
- **user/** - обработчики пользовательских команд (с голосовой поддержкой)
- **study/** - обработчики для изучения слов (полностью рефакторированы)

#### Keyboards
Модули формирования клавиатур (все обновлены с использованием централизованных констант)

#### Utils
Утилиты для обработки ошибок, форматирования, работы с API

#### States
Централизованные определения состояний FSM включая meta-состояния

### Процесс взаимодействия с пользователем (УЛУЧШЕННЫЙ)

```
┌───────────────┐         ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│               │         │               │         │               │         │               │
│  Сообщение    │─────────►  AuthMiddleware│─────────►  Обработчик   │─────────►    Backend    │
│  пользователя │         │               │         │    команд     │         │               │
│               │         │ • Регистрация │         │ • Константы   │         │               │  
└───────────────┘         │ • Авторизация │         │ • Парсеры     │         └───────────────┘
                          │ • Health Check│         │ • Голос       │                 │
                          │ • Error Handle│         └───────────────┘                 │
                          └───────┬───────┘                 │                         ▼
                                  │                         ▼                 ┌───────────────┐
                                  ▼                 ┌───────────────┐         │               │
                          ┌───────────────┐         │  Формирование │         │   Обработка   │
                          │  Meta-States  │         │   ответа и    │◄────────┤   запроса и   │
                          │   Handler     │         │  клавиатуры   │         │  базы данных  │
                          │               │         │ • Константы   │         │               │
                          │ • API Error   │         │ • Генераторы  │         └───────────────┘
                          │ • Connection  │         └───────────────┘
                          │ • Unknown Cmd │                 │
                          └───────────────┘                 │
                                  │                         ▼
                                  ▼                 ┌───────────────┐
                          ┌───────────────┐         │               │
                          │  Auto Recovery│         │    Ответ      │
                          │  + Admin Alert│         │ пользователю  │
                          └───────────────┘         │               │
                                                   └───────────────┘
```

### Архитектурные улучшения

#### 🆕 НОВОЕ: Enhanced Middleware Stack
1. **AuthMiddleware** - расширенная аутентификация с проверкой здоровья системы
2. **StateValidationMiddleware** - валидация и восстановление поврежденных состояний FSM
3. **AdminOnlyMiddleware** - контроль доступа администраторов с улучшенной обработкой ошибок
4. **UserRegistrationMiddleware** - проверка регистрации пользователей

#### 🆕 НОВОЕ: System Health & Monitoring
- **Health Checks** - автоматическая проверка API и БД при запуске
- **Admin Notifications** - уведомления о статусе системы
- **Error Recovery** - автоматическое восстановление после сбоев
- **State Validation** - проверка целостности состояний FSM

### 🆕 НОВОЕ: Meta-состояния и системная обработка ошибок

#### Типы Meta-состояний

1. **CommonStates.handling_api_error**
   - Обработка ошибок API (500, 400, 422)
   - Автоматические retry попытки
   - Уведомления администраторов о критических ошибках

2. **CommonStates.connection_lost**
   - Обработка потери соединения с backend
   - Автоматическая проверка восстановления соединения
   - Graceful degradation при недоступности API

3. **CommonStates.unknown_command**
   - Обработка неизвестных команд
   - Интеллектуальные подсказки похожих команд
   - Автоматическое обучение на основе частых ошибок

#### Автоматическое восстановление

```
┌─────────────────┐
│   Ошибка API    │
│   или потеря    │
│   соединения    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Переход в     │    │   Автоматическая│    │   Восстановление│
│  Meta-состояние │───►│    проверка     │───►│   или escalation│
└─────────────────┘    └─────────────────┘    └─────────────────┘
          │                       │                       │
          ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Уведомление     │    │ Health Check    │    │ Admin Alert +   │
│ пользователя    │    │ + Retry Logic   │    │ Detailed Logs   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Backend (REST API)

Backend предоставляет REST API для взаимодействия с базой данных.

### Архитектурные слои Backend

1. **Маршруты (Routes)** - обрабатывают HTTP запросы и ответы
2. **Сервисы (Services)** - содержат бизнес-логику
3. **Репозитории (Repositories)** - отвечают за доступ к данным

```
┌───────────────────────────────────────────────────┐
│                      Routes                        │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │languages│   │  words  │   │  users  │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                     Services                       │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │ service │   │ service │   │ service │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                   Repositories                     │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │repository│  │repository│  │repository│         │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                    MongoDB                         │
└───────────────────────────────────────────────────┘
```

### Технический стек Backend

- **FastAPI** - асинхронный фреймворк для API
- **Motor** - асинхронный драйвер MongoDB для Python
- **Pydantic** - валидация данных и сериализация
- **Hydra** - управление конфигурацией

## Подсистема изучения слов

Подсистема изучения слов включает несколько компонентов:

### 1. Модели данных
- **UserWordState** - состояние изучения слова
- **HintState** - состояние подсказок

### 2. Процесс изучения слов с поддержкой meta-состояний

```
┌────────────────┐
│  Начало        │
│  процесса      │
│  (/study)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Health Check  │    ✗    │  Meta-State:   │
│  API & DB      │────────►│  Connection    │
└───────┬────────┘         │  Lost          │
        │ ✓                └────────────────┘
        ▼
┌────────────────┐
│  Получение     │
│  слов с учетом │
│  настроек      │
└───────┬────────┘
        │
        ▼
┌────────────────┐
│  Отображение   │
│  слова         │
│  пользователю  │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Действия      │────────►│  Обновление    │
│  пользователя  │         │  статистики и  │
└───────┬────────┘         │  интервалов    │
        │                  └───────┬────────┘
        ▼                          │
┌────────────────┐                 │
│  Переход к     │◄────────────────┘
│  следующему    │
│  слову         │
└────────────────┘
```

### 3. Система интервального повторения

- Начальный интервал при правильном ответе: 1 день
- При последующих правильных ответах интервал увеличивается: 1→2→4→8→16→32 дня
- При неправильном ответе или использовании подсказки интервал сбрасывается в 0

## Система настроек пользователя

Система позволяет каждому пользователю настраивать процесс обучения для каждого языка:

| Настройка | Описание | Значение по умолчанию |
|-----------|----------|-------------|
| **start_word** | Начальный номер слова | 1 |
| **skip_marked** | Пропуск/показ помеченных слов | false |
| **use_check_date** | Учет даты следующей проверки | true |
| **show_hints** | Отображение кнопок подсказок | true |
| **🆕 show_debug** | Отображение отладочной информации | false |

Настройки хранятся в коллекции `user_language_settings` и сохраняются между сессиями.

## Меры безопасности и производительности

1. **Внедрение зависимостей (DI)** - все компоненты получают зависимости через FastAPI Depends
2. **Обработка ошибок** - централизованная система обработки ошибок API
3. **Асинхронная обработка** - неблокирующие операции для высокой производительности
4. **Валидация данных** - строгая валидация всех входящих данных через Pydantic
5. **🆕 Meta-State Error Handling** - автоматическая обработка системных ошибок
6. **🆕 Health Monitoring** - постоянный мониторинг состояния системы
7. **🆕 Graceful Degradation** - продолжение работы при частичных сбоях

## Схема потока данных (ОБНОВЛЕНО)

```
┌─────────────────────┐
│                     │
│     Пользователь    │
│                     │
└──────────┬──────────┘
           │
           ▼
┌──────────────────────┐      ┌─────────────────────┐
│    Telegram-бот      │      │   Meta-States       │
│    (Frontend)        │─────►│   Error Handler     │
└──────────┬───────────┘      └─────────────────────┘
           │                             ▲
           ▼                             │
┌──────────────────────┐      ┌─────────────────────┐
│  Health Check +      │      │   База языков и     │
│  Auth Middleware     │─────►│   слов (MongoDB)    │
└──────────┬───────────┘      └─────────────────────┘
           │                             ▲
           ▼                             │
┌──────────────────────┐                 │
│  Запросы к Backend   │                 │
│       API            │                 │
└──────────┬───────────┘                 │
           │                             │
           ▼                             │
┌──────────────────────┐                 │
│  Обработка запросов  │                 │
│  в Backend           │─────────────────┘
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐      ┌─────────────────────┐
│  Данные пользователя │      │   Admin Alerts &    │
│  (Прогресс, настройки)│─────►│   System Monitoring │
└──────────────────────┘      └─────────────────────┘
```

## Модернизация архитектуры

### 🆕 НОВЫЕ компоненты

1. **Meta-States System**
   - Системная обработка ошибок
   - Автоматическое восстановление
   - Уведомления администраторов

2. **Enhanced Middleware Stack**
   - Валидация состояний FSM
   - Проверка здоровья системы
   - Улучшенная аутентификация

3. **System Monitoring**
   - Health checks при запуске
   - Мониторинг соединений
   - Автоматические alerts

4. **Improved Error Handling**
   - Централизованная обработка ошибок
   - Контекстные сообщения
   - Автоматическое восстановление

### Преимущества новой архитектуры

- **Надежность** - автоматическое восстановление после ошибок
- **Мониторинг** - полная видимость состояния системы
- **Администрирование** - автоматические уведомления о проблемах
- **Пользовательский опыт** - graceful handling всех ошибок
- **Масштабируемость** - готовность к росту нагрузки
- **Отладка** - подробные логи и контекстная информация

Эта архитектура обеспечивает:
- Независимость компонентов
- Гибкость масштабирования
- Простоту сопровождения
- Возможность быстрой разработки новых функций
- **🆕 Высокую надежность и автоматическое восстановление**
- **🆕 Полный мониторинг и алертинг системы**
