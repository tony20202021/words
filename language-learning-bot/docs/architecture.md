# Архитектура проекта

## Содержание

1. [Общий обзор](#общий-обзор)
2. [Схема взаимодействия компонентов](#схема-взаимодействия-компонентов)
3. [Frontend (Telegram-бот)](#frontend-telegram-бот)
4. [Backend (REST API)](#backend-rest-api)
5. [База данных MongoDB](#база-данных-mongodb)
6. [Потоки данных](#потоки-данных)
7. [Принципы масштабирования](#принципы-масштабирования)

## Общий обзор

Language Learning Bot построен на современной модульной архитектуре с четким разделением на независимые компоненты:

- **Frontend (Telegram-бот)** - взаимодействие с пользователем через Telegram API
- **Backend (REST API)** - обработка бизнес-логики и работа с базой данных
- **База данных (MongoDB)** - хранение данных о языках, словах и пользователях
- **Common (Общие модули)** - утилиты, используемые несколькими компонентами

## Схема взаимодействия компонентов

```
┌─────────────────┐      HTTP      ┌─────────────────┐      MongoDB     ┌─────────────────┐
│                 │     запросы    │                 │     драйвер      │                 │
│   Frontend      │◄──────────────►│    Backend      │◄────────────────►│    MongoDB      │
│   (Telegram)    │                │    (REST API)   │                  │   (Database)    │
│                 │                │                 │                  │                 │
└─────────┬───────┘                └─────────────────┘                  └─────────────────┘
          │                                  ▲                                   ▲
          │ Telegram Bot API                 │                                   │
          │                                  │                          ┌─────────┴─────────┐
          ▼                                  │                          │                   │
┌─────────────────┐                         │                          │   Администратор   │
│               │                         │                          │   (Консоль)       │
│  Пользователь │                         │                          │                   │
│    (Чат)      │                         │                          └───────────────────┘
│               │                         │
└───────────────┘                         │
                                          │
                                          ▼
                                ┌─────────────────┐
                                │    Служебные    │
                                │    скрипты      │
                                │                 │
                                │ • init_db.py    │
                                │ • seed_data.py  │
                                │ • admin_manager │
                                └─────────────────┘
```

## Frontend (Telegram-бот)

Frontend отвечает за взаимодействие с пользователями через Telegram и построен на следующих принципах:

### Архитектурные слои

```
┌─────────────────────────────────────┐
│           Telegram API              │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│          Bot Layer                  │
│  • Обработка событий                │
│  • Middleware                       │
│  • FSM состояния                    │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│        Handlers Layer               │
│  • User handlers                    │
│  • Admin handlers                   │
│  • Study handlers                   │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│       Business Logic Layer          │
│  • API Client                       │
│  • State management                 │
│  • Utils                            │
└─────────────────────────────────────┘
```

### Ключевые компоненты

- **Bot** - основной класс бота с конфигурацией
- **Handlers** - модульная система обработчиков событий
- **Middleware** - промежуточное ПО для аутентификации и авторизации
- **States** - управление состояниями FSM
- **API Client** - взаимодействие с Backend API
- **Utils** - вспомогательные утилиты

### Технологический стек

- **aiogram 3.x** - фреймворк для Telegram ботов
- **Hydra** - управление конфигурацией
- **Pillow** - генерация изображений
- **FFmpeg** - обработка аудио

## Backend (REST API)

Backend предоставляет REST API и построен по принципам чистой архитектуры:

### Архитектурные слои

```
┌─────────────────────────────────────┐
│           API Layer                 │
│  • Routes                           │
│  • Request/Response handling        │
│  • Validation                       │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│        Business Layer               │
│  • Services                         │
│  • Business logic                   │
│  • Domain rules                     │
└─────────────────┬───────────────────┘
                  │
┌─────────────────┴───────────────────┐
│         Data Layer                  │
│  • Repositories                     │
│  • Database access                  │
│  • Data models                      │
└─────────────────────────────────────┘
```

### Компоненты Backend

1. **Routes** - определение HTTP эндпоинтов
2. **Services** - бизнес-логика приложения
3. **Repositories** - доступ к данным
4. **Schemas** - валидация и сериализация данных

### Технологический стек

- **FastAPI** - асинхронный веб-фреймворк
- **Motor** - асинхронный драйвер MongoDB
- **Pydantic** - валидация данных
- **Hydra** - управление конфигурацией

## База данных MongoDB

MongoDB используется как основное хранилище данных с следующей структурой:

### Коллекции

| Коллекция | Назначение |
|-----------|------------|
| `languages` | Языки для изучения |
| `words` | Слова с переводами и транскрипциями |
| `users` | Пользователи системы |
| `user_statistics` | Статистика изучения слов |
| `user_language_settings` | Настройки пользователей по языкам |


## Потоки данных

### Поток изучения слов

```
┌─────────────┐    HTTP     ┌─────────────┐    Query    ┌─────────────┐
│  Frontend   │─────────────►│   Backend   │─────────────►│  MongoDB    │
│             │    Request  │             │             │             │
│ User Action │             │ API Service │             │ Collection  │
└─────────────┘             └─────────────┘             └─────────────┘
       ▲                           │                           │
       │                           │                           │
       │    Response               │    Data                   │
       │                           ▼                           ▼
┌─────────────┐              ┌─────────────┐              ┌─────────────┐
│  Updated    │◄─────────────│  Processed  │◄─────────────│  Retrieved  │
│  Interface  │              │    Data     │              │    Data     │
└─────────────┘              └─────────────┘              └─────────────┘
```

### Поток администрирования

```
┌─────────────┐    Command   ┌─────────────┐    Direct    ┌─────────────┐
│   Admin     │─────────────►│   Script    │─────────────►│  MongoDB    │
│   Script    │              │             │    Access   │             │
└─────────────┘              └─────────────┘              └─────────────┘
       ▲                           │                           │
       │                           │                           │
       │    Result                 │    Operation              │
       │                           ▼                           ▼
┌─────────────┐              ┌─────────────┐              ┌─────────────┐
│  Console    │◄─────────────│  Execution  │◄─────────────│   Update    │
│   Output    │              │   Result    │              │  Complete   │
└─────────────┘              └─────────────┘              └─────────────┘
```

## Принципы масштабирования

### Горизонтальное масштабирование

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│   Bot       │  │   Bot       │  │   Bot       │
│ Instance 1  │  │ Instance 2  │  │ Instance N  │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
       ┌─────────────────────────────────────┐
       │          Load Balancer              │
       └─────────────────┬───────────────────┘
                        │
                        ▼
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│  Backend    │  │  Backend    │  │  Backend    │
│   API 1     │  │   API 2     │  │   API N     │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
                        ▼
       ┌─────────────────────────────────────┐
       │         MongoDB Cluster             │
       │      (Replica Set + Sharding)       │
       └─────────────────────────────────────┘
```
