# Архитектура проекта

## Содержание

1. [Общий обзор](#общий-обзор)
2. [Схема взаимодействия компонентов](#схема-взаимодействия-компонентов)
3. [Структура базы данных MongoDB](#структура-базы-данных-mongodb)
4. [Frontend (Telegram-бот)](#frontend-telegram-бот)
   - [Компоненты Frontend](#компоненты-frontend)
   - [Процесс взаимодействия с пользователем](#процесс-взаимодействия-с-пользователем)
   - [Архитектурные улучшения](#архитектурные-улучшения)
   - [Meta-состояния и системная обработка ошибок](#meta-состояния-и-системная-обработка-ошибок)
   - [Система генерации изображений слов](#система-генерации-изображений-слов)
5. [Backend (REST API)](#backend-rest-api)
6. [Подсистема изучения слов](#подсистема-изучения-слов)
7. [Система настроек пользователя](#система-настроек-пользователя)
8. [Меры безопасности и производительности](#меры-безопасности-и-производительности)
9. [Схема потока данных](#схема-потока-данных)
10. [Модернизация архитектуры](#модернизация-архитектуры)

## Общий обзор

Language Learning Bot построен на модульной архитектуре с чётким разделением на четыре основные части:

- **Frontend (Telegram-бот)** - отвечает за взаимодействие с пользователем через Telegram API
- **Backend (REST API)** - обрабатывает запросы от фронтенда и работает с базой данных MongoDB
- **Common (Общие модули)** - содержит утилиты и модули, используемые как фронтендом, так и бэкендом

Такое разделение обеспечивает гибкость и масштабируемость: в будущем можно легко заменить фронтенд на другой интерфейс (мобильное приложение, веб-интерфейс), сохранив функциональность бэкенда, при этом продолжая использовать общие утилиты для обеспечения единообразного поведения всей системы.

## Схема взаимодействия компонентов (ОБНОВЛЕНО)

```
┌─────────────────┐      HTTP      ┌─────────────────┐      MongoDB     ┌─────────────────┐
│                 │     запросы    │                 │     драйвер      │                 │
│   Frontend      │◄──────────────►│    Backend      │◄────────────────►│    MongoDB      │
│   (Telegram)    │                │    (REST API)   │                  │   (Database)    │
│                 │                │                 │                  │                 │
└─────────┬───────┘                └─────────────────┘                  └─────────────────┘
          │                                  ▲                                   ▲
          │                                  │                                   │
          ▼                                  │                                   │
┌─────────────────┐                         │                          ┌─────────┴─────────┐
│ Meta-States     │                         │                          │                   │
│ Error Handling  │◄────────────────────────┘                          │   Администратор   │
│                 │                                                     │   (Консоль)       │
│ • API Errors    │                                                     │                   │
│ • Connection    │                                                     └───────────────────┘
│ • Unknown Cmds  │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐                                                   ┌─────────┴─────────┐
│  Централизованные │                                                   │                   │
│     Утилиты      │                                                   │   Система         │
│                 │                                                   │   Мониторинга     │
│ • Константы     │                                                   │                   │
│ • Состояния FSM │                                                   │ • Health Check    │
│ • Голосовые     │                                                   │ • Admin Alerts    │
│ • Middleware    │                                                   │ • Auto Recovery   │
│ • Word Images   │◄──────────────────────────────────────────────────┤ • Image Generation│
└─────────────────┘                                                   └───────────────────┘
          ▲
          │ Telegram Bot API
          │
┌─────────┴───────┐
│               │
│  Пользователь │
│    (Чат)      │
│               │
└───────────────┘
```

## Структура базы данных MongoDB

MongoDB - документоориентированная NoSQL база данных, в проекте используются следующие коллекции:

| Коллекция | Описание | Ключевые поля |
|-----------|----------|---------------|
| languages | Информация о языках для изучения | _id, name_ru, name_foreign |
| words | Слова для изучения | _id, language_id, word_foreign, translation, transcription, word_number |
| users | Пользователи системы | _id, telegram_id, username, first_name, last_name, is_admin |
| user_statistics | Статистика изучения слов | _id, user_id, word_id, language_id, score, check_interval, next_check_date |
| user_language_settings | Настройки пользователей по языкам | _id, user_id, language_id, start_word, skip_marked, use_check_date, show_hints, show_debug |

## Frontend (Telegram-бот)

Frontend построен на улучшенной модульной архитектуре с поддержкой meta-состояний:

### Компоненты Frontend

#### API Client
- Модуль взаимодействия с Backend API
- Автоматические повторные попытки при ошибках
- Унифицированные ответы с обработкой ошибок

#### Bot Handlers
Обработчики команд, разделенные на логические группы:

- **common/** - обработчики meta-состояний:
- **admin/** - обработчики администрирования
- **user/** - обработчики пользовательских команд
- **study/** - обработчики для изучения слов

#### Keyboards
Модули формирования клавиатур (все обновлены с использованием централизованных констант)

#### Utils
Утилиты для обработки ошибок, форматирования, работы с API

#### Централизованные утилиты
- **Callback Constants** - централизованное управление callback_data
- **Voice Utils** - обработка голосовых сообщений
- **Centralized States** - все состояния FSM в одном месте
- **Enhanced Middleware** - улучшенная аутентификация и авторизация
- **Word Image Generator** - генерация изображений слов с Unicode поддержкой

#### States
Централизованные определения состояний FSM включая meta-состояния

#### Meta-States System
- **Common Handlers** - обработчики системных состояний
- **Error Recovery** - автоматическое восстановление после ошибок
- **Health Monitoring** - мониторинг состояния системы
- **Admin Notifications** - уведомления администраторов

### Система генерации изображений слов

#### Архитектура модуля генерации изображений
│ Компоненты:                                                 │
│ • Автоподбор размера шрифта                                 │
│ • Unicode шрифты (китайские, арабские, хинди и др.)         │
│ • Умное позиционирование (центрирование)                    │
│ • Конфигурируемый дизайн                                    │
│ • Асинхронная генерация                                     │
│ • Временные файлы с автоочисткой                            │


#### Middleware Stack
1. **AuthMiddleware** - расширенная аутентификация с проверкой здоровья системы
2. **StateValidationMiddleware** - валидация и восстановление поврежденных состояний FSM
3. **AdminOnlyMiddleware** - контроль доступа администраторов с улучшенной обработкой ошибок
4. **UserRegistrationMiddleware** - проверка регистрации пользователей

#### Типы Meta-состояний

1. **CommonStates.handling_api_error**
   - Обработка ошибок API (500, 400, 422)
   - Автоматические retry попытки
   - Уведомления администраторов о критических ошибках

2. **CommonStates.connection_lost**
   - Обработка потери соединения с backend
   - Автоматическая проверка восстановления соединения
   - Graceful degradation при недоступности API

3. **CommonStates.unknown_command**
   - Обработка неизвестных команд
   - Интеллектуальные подсказки похожих команд
   - Автоматическое обучение на основе частых ошибок

#### Состояния для работы с изображениями

4. **StudyStates.viewing_word_image**
   - Просмотр крупного изображения слова
   - Навигация обратно к изучению
   - Обработка ошибок генерации изображений

#### Автоматическое восстановление

```
┌─────────────────┐
│   Ошибка API    │
│   или потеря    │
│   соединения    │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Переход в     │    │   Автоматическая│    │   Восстановление│
│  Meta-состояние │───►│    проверка     │───►│   или escalation│
└─────────────────┘    └─────────────────┘    └─────────────────┘
          │                       │                       │
          ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Уведомление     │    │ Health Check    │    │ Admin Alert +   │
│ пользователя    │    │ + Retry Logic   │    │ Detailed Logs   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## Backend (REST API)

Backend предоставляет REST API для взаимодействия с базой данных.

### Архитектурные слои Backend

1. **Маршруты (Routes)** - обрабатывают HTTP запросы и ответы
2. **Сервисы (Services)** - содержат бизнес-логику
3. **Репозитории (Repositories)** - отвечают за доступ к данным

```
┌───────────────────────────────────────────────────┐
│                      Routes                        │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │languages│   │  words  │   │  users  │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                     Services                       │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │ service │   │ service │   │ service │          │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                   Repositories                     │
│                                                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ...    │
│  │language │   │  word   │   │  user   │          │
│  │repository│  │repository│  │repository│         │
│  └─────────┘   └─────────┘   └─────────┘          │
└───────────────────────────────────────────────────┘
                      │
                      │
                      ▼
┌───────────────────────────────────────────────────┐
│                    MongoDB                         │
└───────────────────────────────────────────────────┘
```

### Технический стек Backend

- **FastAPI** - асинхронный фреймворк для API
- **Motor** - асинхронный драйвер MongoDB для Python
- **Pydantic** - валидация данных и сериализация
- **Hydra** - управление конфигурацией

## Подсистема изучения слов

Подсистема изучения слов включает несколько компонентов:

### 1. Модели данных
- **UserWordState** - состояние изучения слова
- **HintState** - состояние подсказок

### 2. Процесс изучения слов с поддержкой meta-состояний и изображений

```
┌────────────────┐
│  Начало        │
│  процесса      │
│  (/study)      │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Health Check  │    ✗    │  Meta-State:   │
│  API & DB      │────────►│  Connection    │
└───────┬────────┘         │  Lost          │
        │ ✓                └────────────────┘
        ▼
┌────────────────┐
│  Получение     │
│  слов с учетом │
│  настроек      │
└───────┬────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Отображение   │         │  Генерация     │
│  слова         │◄────────┤  изображения   │
│  пользователю  │         │  (/show_big)   │
└───────┬────────┘         └────────────────┘
        │
        ▼
┌────────────────┐         ┌────────────────┐
│  Действия      │────────►│  Обновление    │
│  пользователя  │         │  статистики и  │
└───────┬────────┘         │  интервалов    │
        │                  └───────┬────────┘
        ▼                          │
┌────────────────┐                 │
│  Переход к     │◄────────────────┘
│  следующему    │
│  слову         │
└────────────────┘
```

## Система настроек пользователя

Система позволяет каждому пользователю настраивать процесс обучения для каждого языка:

| Настройка | Описание | Значение по умолчанию |
|-----------|----------|-------------|
| **start_word** | Начальный номер слова | 1 |
| **skip_marked** | Пропуск/показ помеченных слов | false |
| **use_check_date** | Учет даты следующей проверки | true |
| **show_hints** | Отображение кнопок подсказок | true |
| **show_debug** | Отображение отладочной информации | false |

Настройки хранятся в коллекции `user_language_settings` и сохраняются между сессиями.

Bot Handlers
Обработчики команд, разделенные на логические группы:

common/ - обработчики meta-состояний:
admin/ - обработчики администрирования

admin_basic_handlers.py - базовые команды админа, статистика, управление пользователями
admin_language_handlers.py - управление языками и словами (ОБНОВЛЕНО: добавлено редактирование и удаление слов)
admin_upload_handlers.py - загрузка файлов со словами


user/ - обработчики пользовательских команд
study/ - обработчики для изучения слов

States
Централизованные определения состояний FSM включая meta-состояния и новые состояния управления словами:
AdminStates (ОБНОВЛЕНО):

Управление языками: viewing_languages, viewing_language_details, confirming_language_deletion
НОВОЕ: Управление словами: viewing_word_details, editing_word_foreign, editing_word_translation, editing_word_transcription, editing_word_number, confirming_word_deletion
Загрузка файлов: waiting_file, configuring_columns, confirming_file_upload

Keyboards
Модули формирования клавиатур (все обновлены с использованием централизованных констант):
admin_keyboards.py (ОБНОВЛЕНО):

get_word_actions_keyboard() - действия со словами (редактирование, удаление)
НОВОЕ: get_word_edit_keyboard() - меню редактирования полей слова
НОВОЕ: get_word_delete_confirmation_keyboard() - подтверждение удаления слова
НОВОЕ: get_word_back_keyboard() - навигация обратно к деталям слова

Централизованные утилиты

Callback Constants (ОБНОВЛЕНО) - добавлены константы для управления словами:

EDIT_WORD_TEMPLATE, DELETE_WORD_TEMPLATE
EDIT_WORD_FOREIGN_TEMPLATE, EDIT_WORD_TRANSLATION_TEMPLATE
EDIT_WORD_TRANSCRIPTION_TEMPLATE, EDIT_WORD_NUMBER_TEMPLATE
CONFIRM_WORD_DELETE_TEMPLATE, CANCEL_WORD_DELETE_TEMPLATE


Voice Utils - обработка голосовых сообщений
Centralized States - все состояния FSM в одном месте
Enhanced Middleware - улучшенная аутентификация и авторизация
Word Image Generator - генерация изображений слов с Unicode поддержкой

Обновления архитектуры

Последние изменения в архитектуре проекта (v1.3.0):

🆕 Новые файлы и модули

1. **Система проверки прав администратора**
   - `frontend/app/utils/admin_utils.py` - утилиты для проверки прав админа

2. **Специальные клавиатуры для админ-редактирования**

3. **Генератор изображений слов**
   - `frontend/app/utils/word_image_generator.py` - генерация крупных изображений с Unicode


## 🆕 Ключевые изменения архитектуры

### **Новые модули:**
- `admin_utils.py` - проверка прав администратора
- `word_image_generator.py` - генерация изображений слов с Unicode
- `voice_utils.py` - обработка голосовых сообщений
- `user_utils.py` - утилиты для работы с пользователями
- `hint_settings_utils.py` - индивидуальные настройки подсказок

### **Новая структура обработчиков:**
- Четкое разделение на `admin/`, `user/`, `study/`
- Детализированные `word_actions/` для действий со словами
- Специализированные `hint/` обработчики для подсказок
- Подмодуль `file_upload/` для загрузки файлов

### **Расширенная функциональность:**
- Админ-редактирование слов прямо из режима изучения
- Генерация и показ крупных изображений слов
- Голосовые подсказки с распознаванием речи
- Batch-загрузка слов с автоматической подгрузкой партий
- Meta-состояния для обработки системных ошибок

### **Улучшенные утилиты:**
- Централизованные константы callback'ов
- Расширенная система форматирования
- Улучшенная обработка ошибок с восстановлением состояний
- Продвинутые модели состояний с поддержкой партий
