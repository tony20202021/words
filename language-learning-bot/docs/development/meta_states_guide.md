# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è–º –≤ Language Learning Bot

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–í–≤–µ–¥–µ–Ω–∏–µ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è](#–≤–≤–µ–¥–µ–Ω–∏–µ-–≤-meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è)
2. [–¢–∏–ø—ã Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π](#—Ç–∏–ø—ã-meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
3. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º—ã)
4. [–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã](#–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ-–ø–µ—Ä–µ—Ö–æ–¥—ã)
5. [–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π](#–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏-meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
6. [–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞](#—Å–∏—Å—Ç–µ–º–∞-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
7. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π](#—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ-meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π)
8. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)
9. [–û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ](#–æ—Ç–ª–∞–¥–∫–∞-–∏-–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
10. [–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏](#–ª—É—á—à–∏–µ-–ø—Ä–∞–∫—Ç–∏–∫–∏)

## –í–≤–µ–¥–µ–Ω–∏–µ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è

Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è - —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM, –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ—à–∏–±–æ–∫, –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –¥—Ä—É–≥–∏—Ö exceptional —Å–ª—É—á–∞–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è.

### –ó–∞—á–µ–º –Ω—É–∂–Ω—ã Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è?

- **üõ°Ô∏è –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–±–æ–µ–≤
- **üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ**: Graceful recovery –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- **üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å–∏—Å—Ç–µ–º—ã
- **üë®‚Äçüíº –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö
- **üéØ UX**: –ü–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö

## –¢–∏–ø—ã Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π

### 1. CommonStates.handling_api_error

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API (4xx, 5xx —Å—Ç–∞—Ç—É—Å—ã)

**–ö–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è**:
- –û—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ (status >= 500)
- –û—à–∏–±–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ (status >= 400)
- –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö
- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–ü—Ä–∏–º–µ—Ä –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**:
```python
# –í middleware –ø—Ä–∏ –æ—à–∏–±–∫–µ API
if response.status >= 500:
    await state.set_state(CommonStates.handling_api_error)
    await state.update_data(
        error_details=error_msg,
        error_time=str(datetime.now()),
        error_status=response.status
    )
```

### 2. CommonStates.connection_lost

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å backend

**–ö–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è**:
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API (status = 0)
- –¢–∞–π–º–∞—É—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –°–µ—Ç–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MongoDB

**–ü—Ä–∏–º–µ—Ä –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**:
```python
# –í middleware –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
try:
    health_response = await api_client._make_request("GET", "/health")
    if not health_response.get("success"):
        await state.set_state(CommonStates.connection_lost)
except Exception as e:
    await state.set_state(CommonStates.connection_lost)
```

### 3. CommonStates.unknown_command

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–ö–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è**:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É
- –ö–æ–º–∞–Ω–¥–∞ –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ
- –û–ø–µ—á–∞—Ç–∫–∏ –≤ –∫–æ–º–∞–Ω–¥–∞—Ö

**–ü—Ä–∏–º–µ—Ä –∞–∫—Ç–∏–≤–∞—Ü–∏–∏**:
```python
# –í middleware –ø—Ä–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ
if isinstance(event, Message) and self._is_unknown_command(event):
    await handle_unknown_command(event, state, event.text)
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π

```mermaid
graph TD
    A[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ] --> B[AuthMiddleware]
    B --> C[Health Check]
    C -->|OK| D[–û–±—ã—á–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫]
    C -->|Error| E[Meta-State Transition]
    E --> F[CommonStates Handler]
    F --> G[Auto Recovery]
    G -->|Success| H[–û–±—ã—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞]
    G -->|Failure| I[Admin Alert]
```

### –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
frontend/app/
‚îú‚îÄ‚îÄ bot/handlers/common_handlers.py     # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π
‚îú‚îÄ‚îÄ bot/middleware/auth_middleware.py   # –ü–µ—Ä–µ—Ö–æ–¥—ã –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è
‚îú‚îÄ‚îÄ bot/states/centralized_states.py   # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π
‚îî‚îÄ‚îÄ utils/error_utils.py               # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
```

## –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã

### Middleware-—É—Ä–æ–≤–µ–Ω—å

**AuthMiddleware** –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API –∫–ª–∏–µ–Ω—Ç–∞
2. –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å backend
3. –í–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```python
class AuthMiddleware(BaseMiddleware):
    async def __call__(self, handler, event, data):
        # Health check
        api_connectivity_ok = await self._ensure_api_connectivity(event, data, state)
        if not api_connectivity_ok:
            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
            return
        
        # Unknown command check
        if isinstance(event, Message) and self._is_unknown_command(event):
            await handle_unknown_command(event, state, event.text)
            return
```

### –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏-—É—Ä–æ–≤–µ–Ω—å

**Error Utils** –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–æ–≤:

```python
async def handle_api_error(response, message_obj, transition_to_error_state=True):
    if not response["success"]:
        if transition_to_error_state:
            if response.get("status") == 0:
                await _transition_to_connection_lost(message_obj)
            else:
                await _transition_to_api_error(message_obj, response.get("error"))
```

## –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞

```python
@common_router.message(StateFilter(CommonStates.handling_api_error))
async def handle_api_error_state(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—à–∏–±–∫–∏ API"""
    
    text = message.text.lower().strip() if message.text else ""
    
    if text in ["/retry", "–ø–æ–≤—Ç–æ—Ä–∏—Ç—å"]:
        # –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        await state.clear()
        await message.answer("üîÑ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ.")
    
    elif text in ["/start", "/help"]:
        # –í—ã—Ö–æ–¥ –∏–∑ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è
        await state.clear()
        await message.answer("–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ. –ú–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ä–∞–±–æ—Ç—É.")
    
    else:
        # –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –ø–æ–º–æ—â—å
        await send_contextual_help(state, message, "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è...")
```

### Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏

```python
@common_router.callback_query(StateFilter(CommonStates.connection_lost))
async def handle_connection_lost_callback(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø–æ—Ç–µ—Ä–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
    
    await callback.answer("‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º", show_alert=True)
    
    # –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    health = await check_system_health(callback.bot)
    if health["api_connection"]:
        await state.clear()
        await callback.message.answer("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
```

## –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### Health Check –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ

```python
async def check_system_health(bot: Bot, api_client: APIClient) -> dict:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ"""
    
    health_status = {
        "bot": True,
        "api_connection": False,
        "database": False
    }
    
    try:
        # API connection test
        health_response = await api_client._make_request("GET", "/health")
        health_status["api_connection"] = health_response.get("success", False)
        
        if health_status["api_connection"]:
            # Database test through API
            languages_response = await api_client.get_languages()
            health_status["database"] = languages_response.get("success", False)
            
    except Exception as e:
        logger.error(f"Health check failed: {e}")
    
    return health_status
```

### Admin —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```python
async def notify_admins_about_startup(bot: Bot, health_status: dict, admin_ids: List[int]):
    """–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Å–∏—Å—Ç–µ–º—ã"""
    
    status_icon = "‚úÖ" if all(health_status.values()) else "‚ö†Ô∏è"
    
    startup_message = (
        f"{status_icon} **–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω**\n\n"
        f"ü§ñ –ë–æ—Ç: {'‚úÖ' if health_status['bot'] else '‚ùå'}\n"
        f"üîó API: {'‚úÖ' if health_status['api_connection'] else '‚ùå'}\n"
        f"üóÑÔ∏è –ë–î: {'‚úÖ' if health_status['database'] else '‚ùå'}\n"
        f"–í—Ä–µ–º—è: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    )
    
    for admin_id in admin_ids:
        try:
            await bot.send_message(admin_id, startup_message, parse_mode="Markdown")
        except Exception as e:
            logger.error(f"Failed to notify admin {admin_id}: {e}")
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

```python
async def auto_recover_from_error_state(state: FSMContext, message_obj) -> bool:
    """–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è"""
    
    current_state = await state.get_state()
    
    if current_state == CommonStates.connection_lost.state:
        health = await check_system_health(message_obj.bot)
        
        if health["api_connection"]:
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏
            state_data = await state.get_data()
            important_data = {
                "db_user_id": state_data.get("db_user_id"),
                "current_language": state_data.get("current_language"),
                "is_admin": state_data.get("is_admin", False)
            }
            
            await state.clear()
            await state.update_data(**{k: v for k, v in important_data.items() if v})
            
            await message_obj.answer("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
            return True
    
    return False
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```python
# frontend/tests/test_handlers/test_common/test_common_handlers.py

import pytest
from unittest.mock import AsyncMock, Mock
from app.bot.states.centralized_states import CommonStates
from app.bot.handlers.common_handlers import handle_api_error_state

class TestCommonHandlers:
    
    @pytest.mark.asyncio
    async def test_api_error_retry_command(self):
        """–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥—ã retry –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ API error"""
        
        # Arrange
        message = Mock()
        message.text = "/retry"
        message.answer = AsyncMock()
        
        state = AsyncMock()
        state.clear = AsyncMock()
        
        # Act
        await handle_api_error_state(message, state)
        
        # Assert
        state.clear.assert_called_once()
        message.answer.assert_called_once()
    
    @pytest.mark.asyncio
    async def test_connection_lost_auto_recovery(self):
        """–¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"""
        
        # Arrange
        state = AsyncMock()
        state.get_state.return_value = CommonStates.connection_lost.state
        
        message_obj = Mock()
        message_obj.bot = Mock()
        message_obj.answer = AsyncMock()
        
        # Mock successful health check
        with patch('app.utils.error_utils.check_system_health') as mock_health:
            mock_health.return_value = {"api_connection": True}
            
            # Act
            result = await auto_recover_from_error_state(state, message_obj)
            
            # Assert
            assert result is True
            message_obj.answer.assert_called_with("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!")
```

### –°—Ü–µ–Ω–∞—Ä–Ω—ã–µ —Ç–µ—Å—Ç—ã

```yaml
# frontend/tests/test_scenarios/scenarios/meta_states_recovery.yaml

name: "Meta-States Recovery Scenarios"
description: "Test automatic recovery from meta-states"

scenarios:
  - name: "API Error Recovery"
    steps:
      - action: "simulate_api_error"
        params:
          error_type: "server_error"
          status: 500
      - action: "send_message"
        params:
          text: "/retry"
      - action: "verify_state"
        expected: "normal_operation"
      - action: "verify_message"
        expected: "–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å"

  - name: "Connection Lost Recovery"
    steps:
      - action: "simulate_connection_loss"
      - action: "wait"
        params:
          seconds: 2
      - action: "restore_connection"
      - action: "send_message"
        params:
          text: "test"
      - action: "verify_message"
        expected: "–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
```

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–∏–º–µ—Ä 1: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ

```python
# –í –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–æ–º–∞–Ω–¥—ã /study
from app.utils.error_utils import safe_api_call

async def cmd_study(message: Message, state: FSMContext, api_client):
    """–ö–æ–º–∞–Ω–¥–∞ –Ω–∞—á–∞–ª–∞ –∏–∑—É—á–µ–Ω–∏—è —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫"""
    
    # –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã–∑–æ–≤ API
    success, words = await safe_api_call(
        lambda: api_client.get_study_words(user_id, language_id, params),
        message,
        error_context="–ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ–≤ –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è"
    )
    
    if not success:
        # safe_api_call –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–≤–µ–ª –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
        # –∏ –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        return
    
    # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–±—ã—á–Ω—É—é –ª–æ–≥–∏–∫—É
    await show_study_word(message, words[0], state)
```

### –ü—Ä–∏–º–µ—Ä 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã

```python
# –í –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ
async def cmd_system_status(message: Message, api_client):
    """–ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã"""
    
    health = await check_system_health(message.bot)
    
    status_text = (
        f"üìä **–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã:**\n\n"
        f"ü§ñ –ë–æ—Ç: {'‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç' if health['bot_responsive'] else '‚ùå –û—à–∏–±–∫–∞'}\n"
        f"üîó API: {'‚úÖ –î–æ—Å—Ç—É–ø–µ–Ω' if health['api_connection'] else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}\n"
        f"üóÑÔ∏è –ë–î: {'‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞' if health['database_accessible'] else '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞'}\n"
    )
    
    await message.answer(status_text, parse_mode="Markdown")
```

### –ü—Ä–∏–º–µ—Ä 3: Graceful degradation

```python
# –í middleware —Å graceful degradation
async def _ensure_api_connectivity(self, event, data, state):
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ API —Å graceful degradation"""
    
    api_client = get_api_client_from_bot(data.get("bot"))
    if not api_client:
        # –ü–µ—Ä–µ—Ö–æ–¥ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        await self._handle_no_api_client(event, state)
        return False
    
    try:
        health_response = await api_client._make_request("GET", "/health")
        if not health_response.get("success"):
            # –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –Ω–æ –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
            await self._handle_api_connectivity_issue(event, state, health_response)
            return False
    except Exception as e:
        # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
        await self._handle_api_connectivity_issue(event, state, {"error": str(e), "status": 0})
        return False
    
    return True
```

## –û—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

```python
# –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π
logger.info(f"User {user.id} transitioned to meta-state: {CommonStates.handling_api_error.state}")
logger.error(f"API Error: status={status}, error={error_msg}, user={user.id}")
logger.info(f"Auto-recovery attempt for user {user.id}: success={recovery_success}")
```

### Debug –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

```python
# –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
async def show_debug_info(message: Message, state: FSMContext):
    """–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π"""
    
    current_state = await state.get_state()
    state_data = await state.get_data()
    
    debug_text = (
        f"üîç **Debug Info:**\n"
        f"State: {current_state}\n"
        f"Error details: {state_data.get('error_details', 'None')}\n"
        f"Error time: {state_data.get('error_time', 'None')}\n"
        f"Recovery attempts: {state_data.get('recovery_attempts', 0)}\n"
    )
    
    await message.answer(debug_text, parse_mode="Markdown")
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

```python
# –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –¥–ª—è Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π
class MetaStateMetrics:
    def __init__(self):
        self.error_counts = defaultdict(int)
        self.recovery_success_rate = 0.0
        self.avg_recovery_time = 0.0
    
    def record_error(self, error_type: str):
        self.error_counts[error_type] += 1
    
    def record_recovery(self, success: bool, recovery_time: float):
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
        pass
```

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### 1. –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**‚úÖ DO:**
```python
# –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
important_data = {
    "db_user_id": state_data.get("db_user_id"),
    "current_language": state_data.get("current_language"),
    "is_admin": state_data.get("is_admin", False)
}
await state.update_data(**important_data)
```

**‚ùå DON'T:**
```python
# –ù–µ –æ—á–∏—â–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–∞–∂–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
await state.clear()  # –ü–æ—Ç–µ—Ä—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

**‚úÖ DO:**
```python
# –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ
await handle_api_error(
    response, 
    message, 
    log_prefix="Study word fetch",
    user_prefix="–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–æ–≤"
)
```

**‚ùå DON'T:**
```python
# –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –æ—à–∏–±–∫–∏ –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏
try:
    result = await api_call()
except:
    pass  # –ü–ª–æ—Ö–æ!
```

### 3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç

**‚úÖ DO:**
```python
# –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–π—Ç–µ —á–µ—Ç–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
error_message = (
    "üîå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.\n\n"
    "–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:\n"
    "‚Ä¢ /retry - –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é\n"
    "‚Ä¢ /status - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ\n"
    "‚Ä¢ /start - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
)
```

**‚ùå DON'T:**
```python
# –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –Ω–µ–∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
await message.answer("–û—à–∏–±–∫–∞")  # –°–ª–∏—à–∫–æ–º –æ–±—â–µ–µ!
```

### 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**‚úÖ DO:**
```python
# –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –æ—à–∏–±–æ–∫
@pytest.mark.parametrize("error_status", [400, 500, 502, 503])
async def test_api_error_handling(error_status):
    # –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
```

**‚ùå DON'T:**
```python
# –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ "happy path"
async def test_only_success_case():
    # –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã
```

### 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**‚úÖ DO:**
```python
# –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –≤ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è
logger.info(f"Meta-state transition: {user.id} -> {meta_state}")
logger.error(f"System error: {error_details}", extra={"user_id": user.id})
```

**‚ùå DON'T:**
```python
# –ù–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π
# –ë–µ–∑ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å–∏—Å—Ç–µ–º—ã
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Meta-—Å–æ—Å—Ç–æ—è–Ω–∏—è –≤ Language Learning Bot –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—Ç:

- **üõ°Ô∏è –í—ã—Å–æ–∫—É—é –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å** —Å–∏—Å—Ç–µ–º—ã –∑–∞ —Å—á–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
- **üîÑ –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø–æ—Å–ª–µ —Å–±–æ–µ–≤ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö  
- **üìä –ü–æ–ª–Ω—É—é –≤–∏–¥–∏–º–æ—Å—Ç—å** —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- **üéØ –û—Ç–ª–∏—á–Ω—ã–π UX** –∑–∞ —Å—á–µ—Ç –ø–æ–Ω—è—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- **üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É** —Å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Meta-—Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–µ–ª–∞–µ—Ç –±–æ—Ç–∞ —É—Å—Ç–æ–π—á–∏–≤—ã–º –∫ —Ä–∞–∑–ª–∏—á–Ω—ã–º —Ç–∏–ø–∞–º —Å–±–æ–µ–≤ –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—É—é —Ä–∞–±–æ—Ç—É –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.
