### Система генерации изображений слов

#### Основные возможности:
- Автоматический подбор размера шрифта для слова и транскрипции
- Поддержка Unicode шрифтов (включая китайские иероглифы)
- Центрирование контента по горизонтали и вертикали
- Конфигурация размеров, цветов и шрифтов

#### Конфигурация изображений в bot.yaml:
```yaml
word_images:
  enabled: true
  width: 800
  height: 400
  fonts:
    word_size: 240
    transcription_size: 240
  colors:
    background: [255, 255, 255]
    text: [50, 50, 50]
    transcription: [100, 100, 100]

    Автоподбор размера шрифта:

Если текст не помещается по ширине, размер автоматически уменьшается на 10% за итерацию
Минимальный размер шрифта: 12px
Отступы по бокам: 20px


Система генерации изображений слов
НОВОЕ: Автоматическая генерация крупных изображений слов с полной поддержкой Unicode:

Поддержка всех языков: включая китайские иероглифы, арабский, хинди и другие
Автоподбор размера шрифта: если текст не помещается, размер автоматически уменьшается
Умное позиционирование: центрирование по горизонтали и вертикали
Настраиваемый дизайн: цвета, размеры, шрифты через конфигурацию

yaml# Конфигурация в bot.yaml
word_images:
  enabled: true
  width: 800
  height: 400
  fonts:
    word_size: 240
    transcription_size: 240
  colors:
    background: [255, 255, 255]
    text: [50, 50, 50]


    Система генерации изображений слов
НОВОЕ: Подсистема для создания крупных изображений слов с полной поддержкой Unicode.
Архитектура модуля генерации изображений
┌─────────────────────────────────────────────────────────────┐
│                WordImageGenerator                           │
├─────────────────────────────────────────────────────────────┤
│ Компоненты:                                                 │
│ • Автоподбор размера шрифта                                 │
│ • Unicode шрифты (китайские, арабские, хинди и др.)         │
│ • Умное позиционирование (центрирование)                    │
│ • Конфигурируемый дизайн                                    │
│ • Асинхронная генерация                                     │
│ • Временные файлы с автоочисткой                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Технические особенности                  │
├─────────────────────────────────────────────────────────────┤
│ • Поиск Unicode шрифтов в системе                           │
│ • Автоматическое тестирование поддержки символов            │
│ • Fallback на системные шрифты                              │
│ • Генерация в памяти (BytesIO)                              │
│ • Оптимизация PNG с качеством 95%                           │
│ • Логирование всех этапов генерации                         │
└─────────────────────────────────────────────────────────────┘
Процесс генерации изображения
┌─────────────────┐
│ Запрос на       │
│ генерацию       │
│ изображения     │
└─────────┬───────┘
          │
          ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│ Загрузка        │      │ Поиск Unicode   │      │ Автоподбор      │
│ конфигурации    │────► │ шрифтов         │────► │ размера шрифта  │
│ из bot.yaml     │      │ в системе       │      │ (итеративно)    │
└─────────────────┘      └─────────────────┘      └─────────┬───────┘
                                                           │
          ┌────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│ Создание        │      │ Позиционирование│      │ Сохранение в    │
│ изображения     │────► │ и отрисовка     │────► │ BytesIO +       │
│ (PIL)           │      │ текста          │      │ отправка в TG   │
└─────────────────┘      └─────────────────┘      └─────────────────┘
Процесс взаимодействия с пользователем
┌───────────────┐         ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
│               │         │               │         │               │         │               │
│  Сообщение    │─────────►  AuthMiddleware│─────────►  Обработчик   │─────────►    Backend    │
│  пользователя │         │               │         │    команд     │         │               │
│               │         │ • Регистрация │         │ • Константы   │         │               │  
└───────────────┘         │ • Авторизация │         │ • Парсеры     │         └───────────────┘
                          │ • Health Check│         │ • Голос       │                 │
                          │ • Error Handle│         │ • Images      │                 │
                          └───────┬───────┘         └───────────────┘                 ▼
                                  │                         │                 ┌───────────────┐
                                  ▼                         ▼                 │               │
                          ┌───────────────┐         ┌───────────────┐         │   Обработка   │
                          │  Meta-States  │         │  Формирование │         │   запроса и   │
                          │   Handler     │         │   ответа и    │◄────────┤  базы данных  │
                          │               │         │  клавиатуры   │         │               │
                          │ • API Error   │         │ • Константы   │         └───────────────┘
                          │ • Connection  │         │ • Генераторы  │
                          │ • Unknown Cmd │         │ • Images      │
                          └───────────────┘         └───────────────┘
                                  │                         │
                                  ▼                         ▼
                          ┌───────────────┐         ┌───────────────┐
                          │  Auto Recovery│         │    Ответ      │
                          │  + Admin Alert│         │ пользователю  │
                          │  + Image Gen  │         │ (+ изображение)│
                          └───────────────┘         └───────────────┘




                          Состояния для работы с изображениями

StudyStates.viewing_word_image

Просмотр крупного изображения слова
Навигация обратно к изучению
Обработка ошибок генерации изображений


Система генерации изображений
Новая подсистема для создания крупных изображений слов:

Модуль: word_image_generator.py
Конфигурация: через bot.yaml секция word_images
Интеграция: команда /show_big и кнопка "Показать крупное написание"
Технологии: PIL (Pillow), Unicode шрифты, асинхронная генерация


Система генерации изображений слов
НОВОЕ: Система генерации крупных изображений слов с полной поддержкой Unicode и автоподбором размера шрифта.
Команды и действия для работы с изображениями
ДействиеОписаниеОбработчикКонстанта/КомандаКоманда /show_bigПоказать крупное изображение текущего словаcmd_show_big_word/show_bigКнопка "Показать крупное написание"Показать изображение через кнопку интерфейсаprocess_show_word_image_callbackCallbackData.SHOW_WORD_IMAGEКнопка "Вернуться к слову"Вернуться от изображения к экрану изученияprocess_back_from_imageCallbackData.BACK_FROM_IMAGE
Состояния для работы с изображениями
СостояниеОписаниеStudyStates.viewing_word_imageПросмотр крупного изображения слова
Технические особенности системы изображений
Автоподбор размера шрифта

Алгоритм: Итеративное уменьшение размера шрифта на 10% до достижения подходящего размера
Минимальный размер: 12px (настраивается)
Применяется к: И слову, и транскрипции независимо
Доступная ширина: Ширина изображения минус отступы по бокам (20px)

Поддержка Unicode

Автоматический поиск Unicode шрифтов в системе:

Windows: msyh.ttc, simsun.ttc, arial.ttf
macOS: PingFang.ttc, Arial.ttf, Helvetica.ttc
Linux: NotoSansCJK-Regular.ttc, DejaVuSans.ttf, и др.


Тестирование поддержки символов: Проверка отображения тестового символа перед использованием шрифта
Fallback механизм: Автоматический переход к системному шрифту при недоступности Unicode шрифтов

Позиционирование и компоновка

Центрирование: По горизонтали и вертикали
Динамический отступ: Между словом и транскрипцией на основе размеров шрифтов
Формула отступа: max(word_font_size * 0.2, transcription_font_size * 0.3)

Конфигурация через bot.yaml
yamlword_images:
  enabled: true              # Включение/отключение генерации
  width: 800                 # Ширина изображения
  height: 400                # Высота изображения
  fonts:
    word_size: 240          # Размер шрифта для слова (стартовый)
    transcription_size: 240 # Размер шрифта для транскрипции (стартовый)
  colors:
    background: [255, 255, 255]    # Белый фон
    text: [50, 50, 50]             # Темно-серый текст
    transcription: [100, 100, 100] # Серый для транскрипции
    border: [200, 200, 200]        # Светло-серая рамка
  temp_dir: "temp"           # Директория для временных файлов
  cleanup_delay: 300         # Автоочистка через 5 минут
  save_debug_files: false    # Сохранение файлов для отладки
Процесс генерации изображения

Загрузка конфигурации из bot.yaml
Поиск Unicode шрифтов в системе с тестированием поддержки символов
Автоподбор размера шрифта:

Для слова: итеративное уменьшение до помещения в доступную ширину
Для транскрипции: аналогично, независимо от слова


Расчет позиций:

Общая высота контента = высота слова + отступ + высота транскрипции
Центрирование всего блока по вертикали
Центрирование каждого элемента по горизонтали


Отрисовка и сохранение:

Создание изображения в памяти (PIL)
Сохранение в BytesIO без временных файлов
Отправка в Telegram как BufferedInputFile



Примеры использования
Через команду:
Пользователь: /show_big
Бот: [отправляет изображение со словом "得" и транскрипцией "[dé]"]
Через кнопку интерфейса:

Появляется кнопка "🔍 Показать крупное написание" когда слово показано
При нажатии отправляется изображение с возможностью вернуться

Автоподбор размера:

Длинное слово: автоматически уменьшается размер шрифта
Длинная транскрипция: уменьшается независимо от слова
Оба элемента помещаются в заданную ширину

Логирование процесса
Система подробно логирует все этапы:

Поиск и тестирование шрифтов
Процесс автоподбора размера
Расчет позиций элементов
Размер сгенерированного изображения


Новые обработчики для изображений

cmd_show_big_word - команда /show_big
process_show_word_image_callback - кнопка показа изображения
process_back_from_image - возврат от изображения
_show_word_image - общая функция генерации и отправки изображения

Интеграция с существующими обработчиками

Кнопка "Показать крупное написание" автоматически появляется в study_keyboards.py
Состояние viewing_word_image интегрировано в FSM
Обработка ошибок генерации изображений через существующую систему meta-состояний


НОВОЕ: Просмотр крупного изображения слова:

Пользователь нажимает "🔍 Показать крупное написание" или использует команду /show_big
Система генерирует изображение с:

Крупным написанием слова на иностранном языке
Транскрипцией (если доступна)
Автоматическим подбором размера шрифта
Поддержкой Unicode (китайские иероглифы, арабский и др.)


Пользователь может вернуться к изучению кнопкой "⬅️ Вернуться к слову"


Система генерации изображений слов
НОВОЕ: Автоматическая генерация крупных изображений слов для улучшения визуального запоминания.
Основные возможности

Полная поддержка Unicode: Китайские иероглифы, арабский, хинди, тайский и все другие языки
Автоматический подбор размера шрифта: Если текст не помещается, размер автоматически уменьшается
Умное позиционирование: Центрирование по горизонтали и вертикали
Настраиваемый дизайн: Размеры, цвета, шрифты через конфигурацию

Способы доступа к изображениям

Команда /show_big - показать изображение текущего слова
Кнопка "🔍 Показать крупное написание" - появляется когда слово показано
Автоматическое появление - кнопка добавляется в интерфейс изучения

Технические особенности
Автоподбор размера шрифта
Стартовый размер (из конфигурации)
         ↓
Проверка: помещается ли текст?
         ↓
   ┌─── НЕТ ─── Уменьшить на 10%
   │              ↓
   │         Повторить проверку
   │              ↓
   └───── ДА ─── Использовать текущий размер

Алгоритм: Итеративное уменьшение на 10% до достижения подходящего размера
Минимальный размер: 12px (защита от слишком мелкого текста)
Отступы: 20px по бокам для обеспечения читаемости
Независимость: Размер слова и транскрипции подбирается независимо

Поддержка Unicode
Система автоматически ищет и тестирует Unicode шрифты:
Windows:

msyh.ttc (Microsoft YaHei)
simsun.ttc (SimSun)
arial.ttf (Arial)

macOS:

/System/Library/Fonts/PingFang.ttc (PingFang SC)
/System/Library/Fonts/Arial.ttf
/System/Library/Fonts/Helvetica.ttc

Linux:

/usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc
/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf
/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf

Тестирование поддержки:

Система проверяет каждый шрифт на тестовом символе (например, "得")
Если символ отображается корректно, шрифт используется
При отсутствии подходящих шрифтов используется системный по умолчанию

Позиционирование и компоновка
┌─────────────────────────┐ ← Высота изображения (400px)
│                         │
│         СЛОВО           │ ← Центрированное слово
│                         │
│       [транскрипция]    │ ← Центрированная транскрипция
│                         │
└─────────────────────────┘
  ← Ширина изображения (800px)
Расчет позиций:

Определение общей высоты контента (слово + отступ + транскрипция)
Центрирование всего блока по вертикали
Индивидуальное центрирование каждого элемента по горизонтали
Динамический отступ: max(word_font_size * 0.2, transcription_font_size * 0.3)

Конфигурация
Настройка через bot.yaml:
yamlword_images:
  enabled: true              # Включение/отключение
  width: 800                 # Ширина изображения
  height: 400                # Высота изображения
  fonts:
    word_size: 240          # Стартовый размер шрифта для слова
    transcription_size: 240 # Стартовый размер для транскрипции
  colors:
    background: [255, 255, 255]    # Белый фон
    text: [50, 50, 50]             # Темно-серый текст
    transcription: [100, 100, 100] # Серый для транскрипции
  temp_dir: "temp"           # Временная директория
  cleanup_delay: 300         # Автоочистка через 5 минут
Состояния FSM для изображений

StudyStates.viewing_word_image - просмотр крупного изображения
Автоматический переход обратно к изучению при нажатии "Вернуться"

Производительность

Генерация в памяти: Используется BytesIO, файлы не создаются на диске
Асинхронность: Генерация не блокирует обработку других сообщений
Оптимизация PNG: Качество 95%, сжатие включено
Автоочистка: Временные файлы (если создаются) удаляются автоматически


НОВОЕ: 4. Настройка изображений слов
Рекомендуемые размеры шрифтов для разных языков:
yaml# Для латинских языков
word_images:
  fonts:
    word_size: 240
    transcription_size: 180

# Для азиатских языков (китайский, японский)
word_images:
  fonts:
    word_size: 200  # Меньше из-за сложности иероглифов
    transcription_size: 120

# Для арабских языков
word_images:
  fonts:
    word_size: 220
    transcription_size: 140
Настройка цветов для лучшей читаемости:
yaml# Высокий контраст (рекомендуется)
colors:
  background: [255, 255, 255]  # Белый
  text: [0, 0, 0]              # Черный
  transcription: [64, 64, 64]  # Темно-серый

# Мягкий контраст
colors:
  background: [248, 249, 250]  # Светло-серый
  text: [33, 37, 41]           # Темный
  transcription: [108, 117, 125]  # Средне-серый

  ### Конфигурация изображений

```yaml
word_images:
  enabled: true
  fonts:
    word_size: 80           # Размер шрифта для слова
    transcription_size: 40  # Размер шрифта для транскрипции
  colors:
    background: [255, 255, 255]  # Белый фон
    text: [50, 50, 50]           # Темно-серый текст
```

