# Организация роутеров и обработчиков в aiogram 3.x

## Содержание
1. [Обзор системы роутингов](#обзор-системы-роутингов)
2. [Правила организации роутеров](#правила-организации-роутеров)
3. [Приоритеты обработчиков](#приоритеты-обработчиков)
4. [Порядок включения роутеров](#порядок-включения-роутеров)
5. [Примеры организации](#примеры-организации)

## Обзор системы роутингов

Aiogram 3.x использует систему роутингов для обработки сообщений. Каждый роутер может содержать обработчики для различных типов событий и фильтров, а также включать в себя другие роутеры, создавая иерархическую структуру.

## Правила организации роутеров

При организации роутеров следует соблюдать несколько важных правил:

1. **Специфическое перед общим**: Более специфичные обработчики (например, для конкретных команд) должны проверяться перед более общими (например, для всех текстовых сообщений).

2. **Команды перед состояниями**: Обработчики для команд (например, `/cancel`) должны проверяться перед обработчиками для состояний FSM.

3. **Вложенность по функциональности**: Группируйте роутеры по функциональности, а не по типам сообщений.

## Приоритеты обработчиков

В aiogram 3.x можно устанавливать приоритеты для обработчиков с помощью флагов:

```python
@router.message(Command("cancel"), flags={"priority": 100})  # Высокий приоритет
@router.message(Command("help"), flags={"priority": 90})     # Средний приоритет
@router.message(flags={"priority": 0})                       # Низкий приоритет (по умолчанию)
Обработчики с высоким приоритетом проверяются перед обработчиками с низким приоритетом.
Порядок включения роутеров
Порядок, в котором роутеры включаются друг в друга, критически важен. Если роутер A включает роутеры B и C, то обработчики в B будут проверяться перед обработчиками в C:
python# Роутеры будут проверяться в следующем порядке:
# 1. cancel_router
# 2. command_router
# 3. state_router
# 4. fallback_router
main_router.include_router(cancel_router)
main_router.include_router(command_router)
main_router.include_router(state_router)
main_router.include_router(fallback_router)
Примеры организации
Пример 1: Организация роутеров для системы изучения слов
python# Создаем основной роутер для процесса изучения
study_router = Router()

# Включаем роутеры в правильном порядке
study_router.include_router(cancel_router)    # Сначала команды отмены
study_router.include_router(commands_router)  # Затем прочие команды
study_router.include_router(word_router)      # Затем обработчики слов
study_router.include_router(hint_router)      # Затем обработчики подсказок
Пример 2: Организация подроутеров для подсказок
python# Создаем основной роутер для подсказок
hint_router = Router()

# Включаем подроутеры в правильном порядке
hint_router.include_router(cancel_router)   # Сначала проверяем команду /cancel
hint_router.include_router(create_router)   # Затем создание подсказок
hint_router.include_router(edit_router)     # Затем редактирование подсказок
hint_router.include_router(toggle_router)   # Затем переключение подсказок

## Структура обработчиков

### Приоритеты обработчиков

1. **common_handlers** (приоритет: самый высокий)
   - Meta-состояния и системные ошибки
   - Команды `/retry`, `/status`

2. **cancel_handlers** (приоритеты: 100)
   - Универсальный обработчик `/cancel`
   - Обработка неожиданных сообщений в состояниях

3. **user_handlers** (приоритет: высокий)
   - Основные пользовательские команды
   - Включает все подроутеры пользователя

4. **admin_handlers** (приоритет: средний)
   - Административные команды
   - Управление системой

5. **language_handlers** (приоритет: низкий)
   - Выбор языка изучения

6. **study_handlers** (приоритет: низкий)
   - Процесс изучения слов
   - **НОВОЕ**: Включает обработчики изображений
